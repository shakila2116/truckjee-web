window.zmailSettings=window.zmailSettings||Zmail.App.extend({}),zmailSettings.FilterApp=function(a){"use strict";$.subscribe("FILTER_SUGGESTION",function(b,c){if(!zmail._newSettings){var d=zmComponent.loadingBand({container:zmsuite.getCenter()[0].$el[0],notToSetInnerHTML:!0});zmAppLoader.load("filter").done(function(){a.models.FilterCollection.getCollectionOf(a.constants.FILTER_TYPES.ALL).then(function(){c&&a.views.showFilterPane(new a.models.Filter(c))}).always(function(){zmUtil.hideMenu(),d&&d()})})}});var b={"true":"classifySenderInSmartFilter","false":"excludeSenderInSmartFilter",undefined:"excludeSenderInSmartFilter"};return a.categoriseMail=function(a){return Backbone.ajax({url:zmail.conPath+"/filter.do",data:{accId:zmail.accId,mode:b[a.include],msgId:a.msgId,filType:a.filType}})},a}(zmailSettings.FilterApp||Zmail.App.extend({})),function(){"use strict";zmUtil.loadWms(),ZE_Init.init(),zmail.fromOtherService||(zmNCenter.init(),zmUtil.updateStreamUnread(),zmUtil.addClickHandlerForStreams(),zmAppLoader.load("updater",{forceLoad:!0,avoidCache:!0}).done(function(){_updater&&_updater.init("4")})),zmUtil.addClickHandlerForMailTo(),zmUtil.addClickHandlerForTasks(),zmComponent.keybindings.registerAll({scope:"default",shortcuts:zmshCut["default"]})}(),zmail.projectsInteg=function(a){"use strict";var b=zmText.get("preUtils"),c={oldSettings:function(){return'<ul><b>ZOHO PROJECTS</b><li><label><i class="msi-uncheck" id="projinteg_switch"></i><span class="pl5" >Enable Projects Integration</span></label><div class="pt10"><div class="SC_select SC_op3 SC_nopntr" id="portalSelection"><select id="projectsPortal" required></select></div></div><div class="pt10 notes">'+b.integration.projects.description+"</div></li></ul>"},newSettings:function(){var a=zmail.imgPath+"project_integration.png";return'<div class="startup pln"><div class="SC_integrationBox"><img src="'+a+'" class="SC_integrationImg"><div class="SC_integrationDiv"><h3>Zoho Projects<div class="onoffButton"><div id="projinteg_switch" data-on="ON" data-off="OFF" class="sdiv sadiv"></div></div></h3><div class="SC_select SC_op3 SC_nopntr" id="portalSelection"><select id="projectsPortal" required></select></div><div>'+b.integration.projects.description+"</div></div></div>"}},d={fetchPortalsList:function(){var b=$.Deferred();return $.ajax({url:zmail.conPath+"/projects/portals/",type:"GET"}).done(function(c,d,e){200===e.status&&(a.portalsList=[],a.portalsData={},c.portals.forEach(function(b){a.portalsList.push({id:b.id_string,name:b.name}),a.portalsData[b.id_string]=b})),b.resolve()}),b},constructPortalsList:function(){var b="";for(var c in a.portalsData){var d=a.portalsData[c].name;b+='<option value="'+c+'"'+(a.portalsData[c]["default"]?"selected":"")+">"+d+"</option>"}return b},updateIntegrationStatus:function(a,b,c){if(zmAdHocSettings.setProjectInteg({enabled:b,id:a}),zmail._newSettings){var d=zmail.Settings.Platform.Components.SettingCardItemManager,e=d.get("zohoprojects-integ");e.setProp("value",b?"Enabled":"Disabled")}else zmailSettings.views.reRenderMainContainer();var f={key:"_settIntegration",info:{action:"projectsIntegration",portalId:a,status:b}};c||zmCrosstab.renew("zm_mail",f)},bindActions:function(c){var e=d.constructPortalsList();c.$el.find("#projectsPortal").append($(e)),c.$el.find("#projinteg_switch").bind("click",function(e){if($.isEmptyObject(a.portalsData))zmAdHocSettings.getProjectInteg().enabled?(d.updateIntegrationStatus("",!1),c.$el.find("#projinteg_switch").removeClass().addClass("sdiv sadiv"),c.$el.find("#portalSelection").addClass("SC_op3 SC_nopntr")):zmUtil.succErrMsg("e",b.integration.projects.noPortal);else{var f=$(e.target),g=!0,h="msi-check",i="msi-uncheck";zmail._newSettings&&(h="sdiv",i="sdiv sadiv"),f.hasClass(i)?(f.removeClass().addClass(h),c.$el.find("#portalSelection").removeClass("SC_op3 SC_nopntr")):(g=!1,f.removeClass().addClass(i),c.$el.find("#portalSelection").addClass("SC_op3 SC_nopntr"));var j=c.$el.find("#projectsPortal").val();j&&d.updateIntegrationStatus(j,g)}}),c.$el.find("#projectsPortal").bind("change",function(){var a=c.$el.find("#projectsPortal").val();d.updateIntegrationStatus(a,!0)})},fillData:function(a){if(zmAdHocSettings.getProjectInteg().enabled){var b="msi-check";zmail._newSettings&&(b="sdiv"),a.$el.find("#projinteg_switch").removeClass().addClass(b),a.$el.find("#portalSelection").removeClass("SC_op3 SC_nopntr")}a.$el.find("#projectsPortal").val(zmAdHocSettings.getProjectInteg().id)}},e={oldSettingsView:function(){function a(){this.$el=$(c.oldSettings()),d.bindActions(this),zmAdHocSettings.getProjectInteg().id&&d.fillData(this)}return new a},newSettingsView:function(){function a(){this.$el=$(c.newSettings()),d.bindActions(this),zmAdHocSettings.getProjectInteg().id&&d.fillData(this)}return new a}};return zmail.isInternalOrgUser&&$.subscribe("settings/integrations/init",function(b,c){function f(){var a;a=c.isNewSettings?e.newSettingsView():e.oldSettingsView(),g.append(a.$el)}var g=$(_zm.getDOM(["DIV",{attrs:{"class":"SC_setInnerLft cl"}}]));c.isNewSettings&&(g=$(_zm.getDOM(["li"]))),$.isEmptyObject(a.portalsList)?d.fetchPortalsList().done(function(){f()}):f(),c.add({getView:function(){return g},index:-1})}),a.settings={view:e,util:{fetchPortalsList:d.fetchPortalsList,updateIntegrationStatus:d.updateIntegrationStatus}},a}(zmail.projectsInteg||{});