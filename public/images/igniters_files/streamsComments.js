window.zmStreamsApp=window.zmStreamsApp||{},window.zmStreamsApp.CommentModule=function(a){"use strict";var b=a.models,c=a.views,d=zmStreamsApp.constants.notifications,e=function(a,c){var d=["commentAdd"],e=c.gid+"#"+c.pid;if(d.indexOf(c.key)!==-1&&b.comments){var f=_.find(b.comments.models,function(a){return a.id===c.pid});f||(f=_.find(b.comments.models,function(a){return a.id===e})),f&&(c.data&&c.data.cmnt?f.updateModel({comment:c.data.cmnt},f,"add"):f.getsinglecomment(c.cid,"","update"))}},f=function(a){var c;c=a.group?a.group.id?a.group.id:a.group:zmail.zuid,a.eid.indexOf("#")===-1&&c&&(a.eid=c+"#"+a.eid);var d;return b&&b.comments&&(d=_.find(b.comments.models,function(b){return b.id===a.eid})),d};a.removeViews=function(a){var b,c;_.each(a,function(a){b=$(a).data();var d=f({eid:b.id});d&&(c=d.getView(b.commentviewid),c.onClose())})},$.subscribe("zmstreamsapp/postactions",e),"undefined"!=typeof zmNCenter&&zmNCenter.handlers.add("streams",function(a,b){b=_zm.copyOf(b),"string"==typeof b.group&&(b.group=$.parseJSON(b.group));var c=b.ntype,g=c===d.add_comment||c===d.comment_group_mention||c===d.comment_mention;g&&e("",{key:"commentAdd",pid:b.eid,cid:b.commentuuid,gid:b.group.id});var h=f(b);if(h){var i=c===d.like_comment,j=c===d.unlike_comment;if(i||j){var k=h.pickComment(b.commentuuid).index,l=_zm.copyOf(h.get("comments"));if(b.nby!==zmail.zuid&&k!==-1){var m=l[k].likes;m=i?m+1:m-1,l[k].likes=m;var n=_.size(l[k].likeList)?l[k].likeList:[];if(i){var o=_.indexOf(n,b.nby);o===-1?n.push(b.nby):l[k].likes=m-1}else n=_.without(n,b.nby);l[k].likeList=n,h.set("comments",l),h.trigger("change:like",b.commentuuid)}}if(c===d.add_private_comment){var p={parentuuid:b.parentuuid,by:b.nby};h.getsinglecomment(b.commentuuid,"","wmsprivatecomment",p)}if(c===d.delete_comment&&h.pickComment(b.commentuuid).index!==-1){var q=h.pickComment(b.commentuuid).index,r=_zm.copyOf(h.get("comments"));r.splice(q,1),h.set("comments",r),h.trigger("change:removeComment",b.commentuuid)}}});var g=function(a,b,d,e){var f=new c.Comment({model:a,postElm:b,highlightComment:d,viewJSON:e});return f.$el};return a.init=function(c,d,e){"undefined"!=typeof zmStreamsApp.GroupApp&&zmStreamsApp.GroupApp.fetchHashTags(),b.comments||(b.comments=new b.CommentCollection({})),a.resizeFn=c.resizeComment,c.parentElm=d;var h,i,j,k=f({eid:c.id,group:c.groupId});if(k){j=k,i=zmStreamsApp.CommentModule.parseInput(c,!0),j.set("attachIndex",i.attachIndex+1);var l=i.comments;if(l.length>k.get("comments").length||i.total!==k.get("total"))k.set({comments:l,total:i.total});else if(l.length){for(var m,n=_zm.copyOf(k.get("comments")),o=0;o<l.length;o++)m=k.pickComment(l[o].id),m.index!==-1&&(n[m.index]=_zm.copyOf(l[o]));k.set("comments",n)}k.set({privateToOwner:i.privateToOwner,mention:i.mention}),i.groupsMention&&k.set("groupsMention",i.groupsMention)}else j=new b.Comments(c,{parse:!0}),b.comments.add(j);return j.get("fetchData")&&j.listAll(),h=g(j,d,e,i)},a.getCommentTemplate=function(b){var c=a.templates.comments(b);$(b.elm).append(c)},a.sendPrivateToOwner=function(a,c,d){if(d)d.addNewPrivate(c);else{var e=_.find(b.comments.models,function(b){return b.id===a});e.trigger("add:commenttoowner",c)}},a.disableComments=function(a,c){var d=_.find(b.comments.models,function(b){return b.id===a});d.set("disableComment",c),d.trigger("change:disableComment",c)},a.setMentions=function(a,c){var d=_.find(b.comments.models,function(b){return b.id===a});d.set("mention",c,{silent:!0}),d.trigger("change:mentionData",c)},a.getLockValue=function(a){var c;b&&b.comments&&(c=_.find(b.comments.models,function(b){return b.id===a}));var d=!1;return c&&(d=c.get("lockInvites")),d},$.subscribe("/mail/selectMail",function(a,b){var c=$(b.containerDOM).find(".sc_cmdv.SCS_cmnt").data(),d=f({eid:c.id});if(d){var e=d.getView(c.commentviewid);e&&e.selectMail(b.mailID,b.mode)}}),a}(zmStreamsApp.CommentModule||Zmail.App.extend({})),function(){"use strict";var a=zmText.get("streams");window.zmStreamsApp=window.zmStreamsApp||Zmail.App.extend({}),zmStreamsApp.CommentModule=function(a){return a}(zmStreamsApp.CommentModule||Zmail.App.extend({})),zmStreamsApp.CommentModule.models=function(b){var c=zmStreamsApp.CommentModule;return b.Comments=Zmail.Model.extend({defaults:{eid:0},url:zmail.conPath+"/comment.do",serialized:function(a,b){var c={},d=this,e=b.mentions,f=b.commentId,g=this.get("shId"),h=b.parent;switch(b.callback=this.updateModel,a){case"addComment":if(c={mode:"add",mentions:e.mention,comments:b.text,actionType:"addComment"},b.replyTo&&(c.replyTo=b.replyTo),e.mention.length){var i=e.offset;c.offsetstarts=i.from,c.offsetends=i.to,c.offsettexts=i.text}var j=b.attachment;j&&j.attachstore&&(c.attachstore=j.attachstore,c.attachname=j.attachname);var k=b.attEntObj;k&&(c.attEntObj=k),b.linkData&&zmStreamsApp.linkPreview.addDataToParams(b.linkData,c),this.get("isSharedFolder")&&(c.shId=g);break;case"likeComment":c={mode:"like",like:b.like,actionType:b.actionType,authorZuid:b.author,commentId:f};break;case"getAllComments":this.get("fetchData")?(c={accId:zmail.accId,comments:!0},b.url=zmail.conPath+"/mailComments.do"):(c={mode:"list",start:f,actionType:this.get("actionType"),count:11},b.extraParamObj={elm:b.elm});break;case"delete":c={mode:"del",actionType:"deleteComment",commentId:f},this.get("isSharedFolder")&&(c.shId=g);break;case"addPrivate":c={mode:"add",actionType:"addComment",comments:b.comment,privateZuid:b.toZid,parentId:h},h&&"undefined"!==h||(c.isPrivateToPost=!0);break;case"getLikes":c={mode:"like",actionType:"viewGroupEntity",commentId:f},b.extraParamObj={elm:b.elm};break;case"getsinglecomment":c={mode:"singlecomment",actionType:"viewGroupEntity",commentId:f};break;case"getRecipientsForMail":c={mailID:this.getUnparsedId(),useConversation:!1,zohoID:zmail.zuid,accountID:zmail.accId,requiredData:"recipientList",mode:"getMailShareData"},b.url=zmail.conPath+"/mailCollab.do"}var l;return b.url.indexOf("mailComments.do")===-1?c.streamsView=!0:l="list",b.success=function(a){"addComment"===b.actionType&&(d.set("replyCid",""),d.set("unPost",""),d.set("atmentions",""),d.set("attachment","")),b.callback(a,d,l,b.ep)},b.url.indexOf("mailCollab.do")===-1&&(c.groupId=this.get("groupId"),c.entityType=this.get("etype"),c.entityId=this.getUnparsedId()),c},getUnparsedId:function(){var a=this.id;return a&&a.indexOf("#")!==-1&&(a=a.substring(a.indexOf("#")+1,a.length)),a},setView:function(a,b){var c=this.get("views");c=c||{},c[a]=b,this.set("views",c)},getView:function(a){var b=this.get("views");return b[a]},sendPrivate:function(a,b,c,d){this.sync("addPrivate",this,{parent:b,comment:a,toZid:c,error:d})},listAll:function(a,b,c){var d=this.pickComment(a).index,e=this.get("total");if(a&&d!==-1&&b!==e){var f=this.get("comments").length,g=b+11>e?e-b:11;if(f===e&&b+g<=f)return void this.trigger("change:listAll",a,c,!0)}return this.sync("getAllComments",this,{commentId:a,elm:c,error:function(a){_zm.succErrMsg("e",a.msg),c.removeClass("zmLock")}})},remove:function(a,b,c){return this.sync("delete",this,{commentId:a,isPrivate:b,parentId:c})},NewComment:function(b){var c=this,d=c.get("createEntityDeferredCallback");return b=b||{},b.error=b.error||function(){},"function"!=typeof d?void c.sync("addComment",c,b):(c.set("lockInvites",b.lockInvites),void d({mentions:b.mentions.mention,includeRecipients:b.includeRecipients,lockInvites:b.lockInvites,selectedMailIds:b.selectedMailIds}).done(function(){c.set("sharedApiCall",!1),c.set("createEntityDeferredCallback",void 0),c.set("entityExists",!0),c.sync("addComment",c,b)}).fail(function(c){c=c||{},c.error=c.error||{},c.error.message=c.error.message||a.common.labels.unknown,c.error.messageOpts=c.error.messageOpts||{},c.error.suppress=c.error.suppress||!1,c.error.messageOpts.suppress=c.error.suppress,b.error({message:c.error.message||a.common.labels.createCommentFail},c.error.messageOpts)}))},pickComment:function(a){var b=this.get("comments"),c=_.pluck(b,"id").indexOf(a),d=b[c];return{commentObj:d,index:c}},getsinglecomment:function(a,b,c,d){var e=this.pickComment(a),f=this.get("replyTo"),g=_.pluck(f,"id").indexOf(a);return e.index!==-1?e.commentObj:"popup"===c&&g!==-1?f[g]:void this.sync("getsinglecomment",this,{commentId:a,ep:{elm:b,type:c,dataObj:d}})},likeComment:function(a,b){var c=this.pickComment(a).commentObj,d=!c.liked,e=c.by,f=d?"likecomment":"unlikecomment";return this.sync("likeComment",this,{commentId:a,like:d,author:e,actionType:f,error:function(){b.removeClass("zmLockLike")}})},getRecipientsForMail:function(){var a=this.get("recipientList");if(a){var b=a[0].orgUsers||[],c=a[1].orgGroups||[];return b.concat(c)}this.sync("getRecipientsForMail",this,{mailID:this.getUnparsedId(),useConversation:!1,zohoID:zmail.zuid,accountID:zmail.accId,requiredData:"recipientList"})},getPvtComments:function(a){var b={};return b=a?this.pickComment(a).commentObj:this.get("privateToOwner")},updateModel:function(a,b,c,d){if(c=c||this.data.mode,this.data){var e=this.data.mode;c="add"===e&&this.data.privateZuid||d&&"wmsprivatecomment"===d.type?"addPrivate":e,c="like"===e&&void 0===this.data.like?"getLikes":c}d&&"wmsprivatecomment"===d.type&&(this.data.parentId=d.dataObj.parentuuid,this.data.privateZuid=d.dataObj.by);var f,g=_zm.copyOf(b.get("comments")),h=this.data.commentId;switch(c){case"add":var i=a.comment,j=g;f=b.get("total"),j.push(i),f=isNaN(f)?j.length:f+1,b.set({total:f,comments:j}),b.get("sharedCall")&&$.publish("/streams/comment",{mode:"add",entityId:b.getUnparsedId(),total:f}),b.trigger("change:add");break;case"like":var k=b.pickComment(h).index,l=b.get("comments");l[k].liked=this.data.like;var m=l[k].likes;m=this.data.like?m+1:m-1,l[k].likes=m;var n=l[k].likeList;n=_.size(n)?n:[],this.data.like?n.push(zmail.zuid):n=_.without(n,zmail.zuid),l[k].likeList=n,b.set("comments",l),b.trigger("change:like",h);break;case"list":var o=g;a=a.comment?a.comment:a;var p=a.order,q=a.comments,r=_(p).map(function(a,b){var c=q[a];return c.sequence=b+1,c});for(var s in o)p.indexOf(o[s].id)===-1&&r.push(o[s]);b.set("comments",r,{silent:!0}),b.trigger("change:listAll",h,this.extraParamObj.elm);break;case"del":f=b.get("total"),j=g,f=isNaN(f)?j.length-1:f-1;var t=h,u=b.pickComment(t).index,v=this.isPrivate,w=this.parentId;if(u!==-1)j.splice(u,1),b.set({total:f,comments:j}),b.get("sharedCall")&&$.publish("/streams/comment",{mode:"delete",entityId:b.getUnparsedId(),total:f});else if(v){var x,y,z,A=g,B=!this.parentId,C=B?{}:b.pickComment(w),D=B?b.get("privateToOwner"):C.commentObj["private"];for(var E in D)if(x=$.isArray(D[E])?D[E]:[D[E]],y=_.pluck(x,"id"),z=y.indexOf(t),z!==-1){x.splice(z,1),B?D[E]=x:A[C.index]["private"][E]=x,b.set("comments",A);break}}b.trigger("change:removeComment",t,b.id);break;case"addPrivate":var F,G,H,I,J,K=a.comment.isprivateToPost,L="private";if(K?(F=b.get("privateToOwner")||{},G=b.get("owner")===zmail.zuid?this.data.privateZuid:zmail.zuid):(J=this.data.parentId,I=b.pickComment(J),G=I.commentObj.by===zmail.zuid?String(this.data.privateZuid):zmail.zuid,F=I.commentObj[L]||{}),H=$.isEmptyObject(F))F[G]=[],F[G].push(a.comment),K||(j=g,I.commentObj[L]=F,j[I.index]=I.commentObj,b.set("comments",j));else{if(!$.isArray(F[G])){var M=F[G];void 0===M?F[G]=[]:F[G]=[M]}F[G].push(a.comment)}K&&b.set("privateToOwner",F),G=K?b.get("owner"):G,b.trigger("add:privateComment",K,a.comment,this.data.parentId,H,G);break;case"getLikes":var N=a.list;N=Object.keys(N);var O=b.pickComment(h).index,P=b.get("comments");P[O].likeList=N,P[O].likes=N.length,b.set("comments",P),b.trigger("change:getLikes",h,this.extraParamObj.elm);break;case"singlecomment":var Q=a.comment;if("popup"===d.type)j=b.get("replyTo")||[],j.push(Q),b.set({replyTo:j});else{var R=b.pickComment(Q.id).index;if(R===-1){j=g,j.push(Q);var S=b.get("total");b.set({comments:j,total:S+1})}}b.trigger("change:singlecomment",h,d);break;case"getMailShareData":b.set("recipientList",a.recipientList)}},parse:function(a){var b=a.id;b.indexOf("#")===-1&&(a.id=a.groupId+"#"+b);var d=c.parseInput(a,!0);return d.attachIndex=0,d}}),b.CommentCollection=Zmail.Collection.extend({model:b.Comments,url:"/zm/stream.do",addModel:function(a,b,c){return this.remove(a,{silent:c}),this.add(a,{at:b,silent:c}),this}}),b}(zmStreamsApp.CommentModule.models)}(),zmStreamsApp.CommentModule.parseInput=function(a,b){"use strict";var c=a.comments||{},d=c.comments,e=c.order||[],f=_(e).map(function(a,b){var c=d[a];return c.sequence=b+1,c}),g=c.total||e.length||a.total,h={total:g,parentElement:a.parentElm,id:a.id,groupId:a.groupId,mention:a.mentions,etype:a.etype,owner:a.owner,privateToOwner:a.privateToOwner,actionType:a.actionType||"viewGroupEntity",sharedCall:a.sharedCall||!1,groupsMention:a.groupsMention||!1,placeHolder:a.placeHolder,isSharedFolder:a.isSharedFolder,shId:a.shId,disableComment:a.disableComment,fixedComment:a.fixedComment||!1,fixedElement:a.fixedElement,miscData:a.miscData||{},sharedApiCall:a.sharedApiCall||!1,createEntityDeferredCallback:a.createEntityDeferredCallback,isDraftShare:a.isDraftShare||!1,entityExists:a.entityExists||!1,fetchData:void 0===a.comments,shGroup:a.shGroup||[],shOwner:a.shOwner,inviteeList:a.inviteeList,recipientList:a.recipientList};return f&&b&&(h.comments=f),h},window.zmStreamsApp=window.zmStreamsApp||{},zmStreamsApp.CommentModule.templates=function(){"use strict";var a={},b=zmStreamsApp.template,c=zmText.get("streams");return a.comments=function(b,d,e){var f=b.id,g=b.comments,h=b.fixedComment||!1,i=b.isShare||!1,j=b.disableComment||!1,k=b.placeHolder,l=h?"fixedComment":"",m=["UL",{attrs:{"class":"Stcmt cmnt_ul","data-type":l,"data-sharedview":b.sharedCall}}],n=_zm.getDOM(m);if(b.notifyId=e,a.commentList(b,n),!h&&!j&&!b.isDisableAdd){var o=a.newcomment({cid:f,sharedCall:b.sharedCall,sharedApiCall:b.sharedApiCall,entityExists:b.entityExists,isDraftShare:b.isDraftShare,attId:d,placeHolder:k,fixedComment:!1,isShare:i});n.appendChild(_zm.getDOM(o))}var p=g.length,q=b.total-p,r=_zm.getDOM(["DIV",{attrs:{"class":"sc_cmdv SCS_cmnt"}}]);if(b.sharedCall&&p&&!b.isDraftShare&&r.appendChild(a.commentHeader()),b.privateToOwner){var s=a.privateToOwner(b.privateToOwner,b.owner,e,b.disableComment);r.appendChild(s)}if(q){var t=b.comments[0].id||"";r.appendChild(a.viewmore(zmText.applyArgs(c.common.labels.viewMoreComments,{count:q}),t,p))}return r.appendChild(n),r},a.commentHeader=function(){return _zm.getDOM(["DIV",{attrs:{"class":"cmntLabel"},child:[["text",c.common.labels.comments]]}])},a.commentList=function(b,d){for(var e,f=b.comments,g=b.notifyId,h=b.disableComment||!1,i=0;i<f.length;i++)if(e=f[i],e.user)d.appendChild(a.comment(e,b)),e["private"]&&!b.isPrint&&a.privateCommentBlock(d,e,"","",g,h);else{var j=e.by||"",k=e.name||(zmCont.getOrgContacts(j)[j]||{}).fn||c.common.labels.unknown,l=e.text||"";d.appendChild(a.systemComment(k,l))}},a.quotedCommentList=function(b,c){for(var d,e=0;e<b.length;e++)d=b[e],c.appendChild(a.quoteComment(d,b))},a.fixedComment=function(b){var c=b.sharedCall?[]:["UL",{attrs:{"class":"Stcmt"}}],d=["DIV",{attrs:{"class":"SCS_cmnt zms_fixed",type:"notification"},child:[c]}],e=_zm.getDOM(d),f=a.newcomment(b);if(b.sharedCall){b.totalCount>0&&e.appendChild(_zm.getDOM(a.commentInfo(b.totalCount))),e.appendChild(f);var g=a.commentActions(b);g.style.display="none",e.appendChild(g)}else{var h=$(e).find(".Stcmt");$(h).append($(f))}return e},a.commentInfo=function(a){var b=["DIV",{attrs:{"class":"cmntInfo"},child:[["I",{attrs:{"class":"msi-comment"}}],["SPAN",{attrs:{"class":"StCnt zm_dIB"},child:[["text",a]]}]]}];return b},a.commentActions=function(b){var d=b.entityExists?[]:["SPAN",{attrs:{"class":"zm_dIB zm_inclr"},child:[["I",{attrs:{"class":"msi-uncheck"}}],["text"," Include everyone "]]}],e=b.entityExists?[]:["I",{attrs:{"class":"msi-Ainvitee inviteeColor"}}],f=b.totalCount?a.commentInfo(b.totalCount):[],g=b.entityExists?{}:b.placeHolder,h="function"==typeof g.button?g.button():g.button;h=h||c.streams.common.comment,b.inviteeList=b.inviteeList||[];var i=b.inviteeList.length?a.addInviteeList(zmCont.getOrgContacts(b.inviteeList.join(","),"Array")):[],j=["DIV",{attrs:{"class":"cmntActions"},child:[["DIV",{attrs:{"class":"SC_flt"},child:[["DIV",{attrs:{"class":"SCS_postAct zm_dIB"},child:[["DIV",{child:[["I",{attrs:{"class":"msi-attachment"}}],["DIV",{attrs:{"class":"SC_SLine"}}],f,["UL",{attrs:{"class":"invitedList"},child:[i]}],["DIV",{attrs:{"class":"SC_SDot"}}],d]}]]}]]}],["DIV",{attrs:{"class":"SC_frt"},child:[["DIV",{attrs:{"class":"zm_dIB zm_slc"},child:[["DIV",{attrs:{"class":"SC_SDot"}}],e]}],["DIV",{attrs:{"class":"SC_PUbtm zm_dIB"},child:[["SPAN",{attrs:{"class":"sel addcomnt"},child:[["text",h]]}]]}]]}]]}];return _zm.getDOM(j)},a.privateCommentBlock=function(b,c,d,e,f,g,h){var i=_zm.getDOM(["LI",{attrs:{"class":"pvtMsg"}}]),j="private";h?b.after(i):b.appendChild(i);var k=d?c:c[j],l=d?e:c.by,m=d?"":c.id,n="",o="";for(n in k)o=zmail.zuid===l?n:l,k[n]&&i.appendChild(a.private_comments(m,o,k[n],!1,d,f,g))},a.newcomment=function(a){var b=a.cid,d=a.attId,e=a.fixedComment,f=a.placeHolder,g=a.entityExists,h=a.sharedApiCall,i=a.isDraftShare,j=a.sharedCall,k=a.isShare;d="p"+b+d;var l=e?"fixed":"";d=d.substring(d.indexOf("#")+1,d.length),f=g?{}:f,f=f||{},f.button=f.button||c.streams.common.comment,f.textArea=f.textArea||c.common.labels.writeComment;var m="function"==typeof f.button?f.button():f.button,n="function"==typeof f.textArea?f.textArea():f.textArea,o=k?[]:["I",{attrs:{"class":"msi-attachment SC_flt"}}],p=j?"":"display:none",q=j&&!g?["DIV",{attrs:{"class":"zm_inclr zm_dIB"},child:[["I",{attrs:{"class":"msi-uncheck"}}],["DIV",{attrs:{"class":"zm_dIB"},child:[["text",c.common.labels.includeEveryone]]}]]}]:[],r=h||i&&!g?["DIV",{attrs:{"class":"SCmb mailSharedLock"},child:[["UL",{child:[["LI",{attrs:{"class":"SC_lbr"},child:[["B",{attrs:{"class":"lockClass"},child:[["I",{attrs:{"class":"msi-Ainvitee inviteeColor"}}],["DIV",{attrs:{"class":"SC_hd"}}]]}]]}]]}]]}]:[],s=["DIV",{attrs:{"class":"cmntText"},child:[["TEXTAREA",{attrs:{placeholder:n,id:"comnt_"+b,"data-attach":d,autocomplete:"off",autocorrect:"off",autocapitalize:"off","data-type":l}}],["I",{attrs:{"class":"msi-smiley"}}]]}],t=["LI",{attrs:{type:"commentbox","class":"zms_txtLI"},child:[["DIV",{attrs:{"class":"zmImg"}}],s,["DIV",{attrs:{"class":"SC_PUbtm",style:p},child:[o,q,r,["SPAN",{attrs:{"class":"addcomnt sel"},child:[["text",m]]}]]}]]}],u=_zm.getDOM(t);return e&&j?u=_zm.getDOM(s):zmail.avatar.get({zuid:zmail.zuid,type:"dom",displayName:zmail.IAMFullName}).done(function(a){var b=$(u).find(".zmImg");$(b).before(a),$(b).remove()}),u},a.addInviteeList=function(a,b){var c,d,e=[],f=a.length;if(d=f>3?3:f,f)for(c=0;c<d;c++)e.push(["IMG",{attrs:{src:a[c].photo}}]);f>d&&e.push(["FONT",{attrs:{"class":"SC_thm"},child:[["text","+"+(f-d)]]}]);var g=["LI",{child:e}];return b?(b=b.querySelector(".invitedList"),b.innerHTML="",b.appendChild(_zm.getDOM(g)),void 0):g},a.viewmore=function(a,b,c){var d=["DIV",{attrs:{"class":"cmntMore","data-cid":b,"data-count":c},child:[["I",{attrs:{"class":"msi-chat"}}],["text",a]]}];return _zm.getDOM(d)},a.createPrivate=function(a,b,d,e){var f=zmCont.getOrgContacts(String(b))[String(b)].fn,g=zmText.applyArgs(c.streams.post.pvtReply,{userName:f}),h="display:none",i="";d||(i="display:none",h="");var j=zmCont.getOrgContacts(String(zmail.zuid))[String(zmail.zuid)].photo,k=[["LI",{attrs:{"class":"pvtRlyLi",style:i},child:[["DIV",{attrs:{"class":"zmImg"},child:[["IMG",{attrs:{src:j}}]]}],["DIV",{child:[["DIV",{attrs:{"class":"cmntText"},child:[["INPUT",{attrs:{"class":"sfocus",placeholder:g,"data-z":b,"data-cid":a,autocomplete:"off",autocorrect:"off",autocapitalize:"off"}}]]}]]}]]}],["LI",{attrs:{"class":"pvtRlyLink",style:h},child:[["SPAN",{attrs:{"class":"SndPrvRep"},child:[["text",c.common.labels.reply]]}]]}]],l=_zm.getDOM(k);zmail.avatar.get({zuid:zmail.zuid,type:"dom",displayName:zmail.IAMFullName}).done(function(a){var b=$(l).children().find(".zmImg");$(b).before(a),$(b).remove()});var m,n=l;if(d){if(m=_zm.getDOM(["LI",{attrs:{"class":"pvtMsg"},child:[["UL",{attrs:{"class":"pvtOwn"}}]]}]),n=m,e){var o=_zm.getDOM(["UL",{attrs:{"class":"pvtOwn"}}]);o.appendChild(m),n=o}m.children[0].appendChild(l)}return n},a.comment=function(a,d){var e=a.id,f=a.by,g=zmCont.getOrgContacts(String(f))[f],h=a.text,i=g.zid===zmail.zuid?c.common.labels.me:g.fn||a.name,j=a.tags,k=d.id,l=d.notifyId,m=d.shOwner,n=d.isShare,o=d.groupId,p=[],q=":",r={text:h,offset:j,group:k,span:a.replyTo,shGroup:d.shGroup,inviteeList:d.inviteeList},s=b.setOffsetValues(r);if(a.replyTo){var t=a.replyToDisplayName||"";p=["SPAN",{attrs:{},child:[["text"," - "+c.common.labels.repliedTo+" "+t+c.common.labels.apostrophes+" "],["SPAN",{attrs:{style:"text-decoration: underline;cursor:pointer","class":"zm_replyto","data-cid":a.replyTo},child:[["text",c.common.labels.commentSmall]]}],s]}],q=""}else p=s;var u=a.on,v=c.common.labels.sendPrivateReply,w=[],x=[],y=[],z=[];n||d.isSharedFolder||(x=d.disableComment?[]:["SPAN",{attrs:{"class":"SndRep","data-cid":e,"data-z":f},child:[["text",c.common.labels.reply]]}],y=["I",{attrs:{"class":"msi-love zmcnt","data-cmid":e}}],z=["FONT",{attrs:{style:a.likes?"":"display:none","data-cid":e,"class":"zm_lcnt"},child:[["text",a.likes?a.likes:""]]}],w=a["private"]?d.disableComment?[]:["SPAN",{attrs:{"class":"SndPrv","data-cid":e,style:"display:none;","data-z":f},child:[["text",v]]}]:d.disableComment?[]:["SPAN",{attrs:{"class":"SndPrv","data-cid":e,"data-z":f},child:[["text",v]]}]);var A,B="";d.isSharedFolder&&m===zmail.zuid&&(A=!0),n||d.isSharedFolder||a.by!==zmail.zuid||(A=!0),A&&(w="",x=[],B=["I",{attrs:{"class":"msi-close delCmnt","data-cid":e}}]);var C=k.indexOf("#")!==-1?k.substring(k.indexOf("#")+1,k.length):k,D=window.location.protocol+"//"+window.location.hostname+zmail.conPath+"/#stream/"+d.groupId+"/"+C+"/"+d.etype+"/"+d.actionType+"/"+a.id,E=d.isSharedFolder?["text",u]:["A",{child:[["text",u]],attrs:{href:D,target:"_blank","class":"dateTime",title:zmStreamsApp.util.getFullDateFormat(parseInt(a.time))}}],F=(a.likes?" contentLiked":"")+(a.liked?" contentILiked":""),G=["DIV",{attrs:{"class":"cmntDet"+F},child:[["SPAN",{attrs:{"class":"time"},child:[E]}],["DIV",{attrs:{"class":"SC_SDot"}}],y,z,["DIV",{attrs:{"class":"SC_SDot",style:x.length?"":"display:none"}}],x,w]}],H=l===e?"zms_comment highlightClass":"zms_comment",I=["LI",{attrs:{"class":H,"data-cid":e},child:[B,["DIV",{attrs:{"class":"SC_avtr"}}],["DIV",{attrs:{"class":"cmntMsg"},child:[["STRONG",{attrs:{"class":"zm_susr","data-zid":f},child:[["text",i+q]]}],p]}]]}],J=_zm.getDOM(I);if(zmail.avatar.get({zuid:a.by,type:"dom",displayName:a.name}).done(function(a){var b=$(J).find(".SC_avtr");$(b[0]).before(a),$(b[0]).remove()}),a.attachments){var K=b.RenderAttachment({attArr:a.attachments,groupId:o,pid:k,type:d.etype,actionType:d.actionType});J.appendChild(K)}return a.link&&zmStreamsApp.linkPreview.addLinkPreviewToComment(a,J,k),J.appendChild(_zm.getDOM(G)),J},a.quoteComment=function(a,d){var e=a.id,f=a.by,g=zmCont.getOrgContacts(String(f))[f],h=a.text,i=g.zid===zmail.zuid?c.common.labels.me:g.fn||a.name,j=a.tags||[],k=d.id,l=d.notifyId,m=d.groupId,n=[],o=":",p={text:h,offset:j,group:k,span:a.replyTo},q=b.setOffsetValues(p);a.replyTo?(n=["SPAN",{attrs:{},child:[["text"," - "+c.common.labels.repliedTo+" "],["SPAN",{attrs:{style:"text-decoration: underline;cursor:pointer","class":"zm_replyto","data-cid":a.replyTo},child:[["text",c.common.labels.commentSmall]]}],q]}],o=""):n=q;var r=a.on,s="",t=(a.likes?" contentLiked":"")+(a.liked?" contentILiked":""),u=["DIV",{attrs:{"class":"cmntDet"+t},child:[["SPAN",{child:[["text",r]]}]]}],v=l===e?"highlightClass":"",w=["LI",{attrs:{"class":v,"data-cid":e},child:[s,["DIV",{attrs:{"class":"SC_avtr"}}],["DIV",{attrs:{"class":"cmntMsg"},child:[["STRONG",{attrs:{"class":"zm_susr","data-zid":f},child:[["text",i+o]]}],n]}]]}],x=_zm.getDOM(w);if(zmail.avatar.get({zuid:a.by,type:"dom",displayName:a.name}).done(function(a){var b=$(x).find(".SC_avtr");$(b[0]).before(a),$(b[0]).remove()}),a.attachments){var y=b.RenderAttachment({attArr:a.attachments,groupId:m,pid:k,type:d.etype,actionType:d.actionType});x.appendChild(y)}return a.link&&zmStreamsApp.linkPreview.addLinkPreviewToComment(a,x,k),x.appendChild(_zm.getDOM(u)),x},a.systemComment=function(a,b){b=(b||"").replace(/\\n/gim,"\n");var d=["LI",{attrs:{"class":"Sactvty"},child:[["DIV",{child:[["B",{child:[["text",a]]}],["text"," : "],["SPAN",{child:[["text",b]],attrs:{style:"word-break: break-all; white-space: pre-wrap;"}}]],attrs:{title:c.common.labels.systemComment}}]]}];return _zm.getDOM(d)},a.selectMailDOM=function(a){var b=["SPAN",{attrs:{"class":"selMail"},child:[["SPAN",{attrs:{"class":"StCnt zm_dIB"},child:[["text",a]]}],["SPAN",{attrs:{"class":"zm_dIB"},child:[["text","MAILS SELECTED"]]}]]}];return _zm.getDOM(b)},a.privateToOwner=function(b,c,d,e){var f=_zm.getDOM(["UL",{attrs:{"class":"pvtOwn"}}]);return a.privateCommentBlock(f,b,!0,c,d,e),f},a.private_comments=function(b,c,d,e,f,g,h){var i,j=f?"pvtOwn":"",k=e?["LI",{attrs:{"class":"pvtMsg"},child:[["UL",{attrs:{"class":"Spvt "+j}}]]}]:["UL",{attrs:{"class":"Spvt "+j}}],l=a.createPrivate(b,c),m=_zm.getDOM(k),n=e?m.children[0]:m;if(d instanceof Array)for(var o=0,p=d.length;o<p;o++)i=a.private_comments.comment(d[o]),d[o].id===g&&_zm.addClass(i,"highlightClass"),n.appendChild(i);else i=a.private_comments.comment(d,h),d.id===g&&_zm.addClass(i,"highlightClass"),n.appendChild(i);return h||n.appendChild(l),e?m:n},a.replyComment=function(a,b){return _zm.getDOM(["DIV",{attrs:{"data-cid":a,"class":"zms_rep"},child:[["text",zmText.applyArgs(c.common.labels.replyToUser,{userName:b})],["I",{attrs:{"class":"msi-close"}}]]}])},a.private_comments.comment=function(a){var d,e=zmCont.getOrgContacts(String(a.by))[a.by];if(e){var f=e.zid===zmail.zuid?c.common.labels.me:e.fn,g={text:a.text,offset:[]},h=b.setOffsetValues(g),i=a.on,j=zmStreamsApp.util.updateTime(parseInt(a.time));j&&(i=j);var k="";a.by===zmail.zuid&&(k=["I",{attrs:{"class":"msi-close delCmnt delPvtCmnt","data-cid":a.id}}]),d=["LI",{child:[k,["DIV",{attrs:{"class":"SC_avtr"}}],["DIV",{attrs:{"class":"cmntMsg"},child:[["STRONG",{child:[["text",f+":"]]}],h]}],["DIV",{attrs:{"class":"cmntDet"},child:[["SPAN",{attrs:{title:zmStreamsApp.util.getFullDateFormat(parseInt(a.time))},child:[["text",i]]}]]}]]}]}var l=_zm.getDOM(d);return zmail.avatar.get({zuid:a.by,type:"dom",displayName:a.name}).done(function(a){var b=$(l).find(".SC_avtr");$(b).before(a),$(b).remove()}),l},a}(),window.zmStreamsApp=window.zmStreamsApp||Zmail.App.extend({}),zmStreamsApp.CommentModule.views=function(a){"use strict";var b,c=zmText.get("streams"),d=c.streams.common,e=d.comment,f=d.commenting;return a.Comment=Zmail.View.extend({attCmpRef:"",template:zmStreamsApp.CommentModule.templates,events:{"click .zmcnt.msi-love":"like","focus textArea":function(){if(this.model.get("sharedCall")&&this.fixedComment){var a=$(this.$el);a.find(".cmntInfoWra").removeClass("cmntInfoWra").children(".cmntInfo").remove(),a.find(".cmntActions").show(),this.model.getRecipientsForMail()}else{var b=this.$el.find(".SC_PUbtm");$(b).show()}},"hover ul.Stcmt":function(){this.reSize()},"keydown textArea":function(a){zmail.mailOpt.isKey&&a.ctrlKey&&13===a.keyCode&&this.publish(a)},"click .addcomnt":"publish","click .cmntMore":function(a){var b=$(a.currentTarget);if(!b.hasClass("zmLock")){b.addClass("zmLock");var c=b.data("cid"),d=b.siblings(".zms_comment").length;this.model.listAll(c,d,b)}},"click .SndRep":"attachReplyTo","click .delCmnt":function(a){var b=$(a.currentTarget),c=b.hasClass("delPvtCmnt"),d=$(b).parents(".pvtMsg").prev(".zms_comment");this.model.remove(b.data("cid"),c,$(d).data("cid"))},"click .SndPrv":function(a){var b=a.currentTarget;$(b).hide(),this.addNewPrivate(b)},"click .zms_rep .msi-close":function(a){var b=$(a.currentTarget).parent();b.parent().find("textArea").data("cid",""),b.remove(),this.model.set("replyCid","")},"click .msi-attachment":"addAttachment","keypress .pvtRlyLi input":function(a){13===a.keyCode&&this.sendPrivate(a)},"click .SndPrvRep":function(a){var b=a.currentTarget;$(b).parent().hide().siblings(".pvtRlyLi").show().find("input").focus()},"click .zm_lcnt":function(a){var b=a.currentTarget,c=this.model,d=$(b).data("cid"),e=c.pickComment(d).commentObj,f=e.likeList;_.size(f)&&e.likes===_.size(f)?this.showCommentLikes(d,b):c.sync("getLikes",this.model,{commentId:d,elm:b})},"click .zm_inclr i":function(a){var b=a.currentTarget;$(b).toggleClass("msi-check"),$(b).toggleClass("msi-uncheck"),this.model.get("sharedCall")&&this.fixedComment&&this.updateInviteeList()},"click .zm_inclr .zm_dIB":function(a){var b=a.currentTarget;$(b).parent().find("i").trigger("click")},"click .zm_replyto":function(a){this.showSingleComment(a.currentTarget)},"click .lockClass":function(a){var b=$(a.currentTarget).filter(".lockClass"),d=$(b).find("i"),e="";d.hasClass("msi-Ainvitee")?(d.removeClass().addClass("msi-Dinvitee"),e=c.common.labels.allowInvites):(d.removeClass().addClass("msi-Ainvitee inviteeColor"),e=c.common.labels.denyInvites),zmComponent.tooltip({elm:b[0],text:e,arrow:"top"})},"focusout textArea":"saveUnpost","click .cmntInfo":function(){zmUtil.setPreviewScroll($(this.$el).find(".cmntLabel")[0],this.$el.find(".SC_Twpr")[0])}},saveUnpost:function(a){var b=a.currentTarget,c=$(b).parent().siblings(".zms_rep");if(c.length){var d=c.data("cid");this.model.set("replyCid",d)}var e=$(b).val(),f=zmMention.getMentions($(b));this.model.set("unPost",e),this.model.set("atmentions",f)},getAttachment:function(){var a={},b=this.attCmpRef;if("undefined"!=typeof b&&""!==b){var d,e,f,g,h=[],i=[];if(g=b.getStoreAttachments(),d=g.tempLocation,g===!1)return a.error={code:1,msg:c.common.messages.uploadPending},a;for(f=d?d.length:0,e=0;e<f;e++)h.push(d[e].fP),i.push(d[e].sN);h&&(a.attachstore=i,a.attachname=h)}return a},getEntityAttachment:function(){var a,b=this.attCmpRef,d={};if("undefined"!=typeof b&&""!==b){var e;if(e=b.getStoreAttachments(),a=e.myAttachment,e===!1)return d.error={code:1,msg:c.common.messages.uploadPending},d;d=a}return JSON.stringify(a)},attachFiles:function(a){var b=this;if(b.attCmpRef)b.attCmpRef.configJSON.eleId=a,b.attCmpRef.init();else{var c=this.callAttachment(a);zmUtil.initAttachComponent(c,function(a){b.attCmpRef=a})}},callAttachment:function(){var a=this.model.get("attachment"),b={componentId:"streams",isNewImp:!0,attachFrom:["desktop","myAttachchment","zDocs","otherCloud"],currentAttachedSize:0,eleId:this.$el.find(".zmCAt"),preAttachedFile:a,onAddAttachment:this.saveAttachment,onRemoveAttachment:this.saveAttachment};return this.model.get("isDraftShare")&&(b.onAddElement=function(){zmStreamsApp.CommentModule.resizeFn()},b.onRemoveElement=function(){zmStreamsApp.CommentModule.resizeFn()}),b},saveAttachment:function(){var a=this.getAllAttachedList();b.set("attachment",a)},like:function(a){var b=a.currentTarget,d=$(b).data("cmid"),e="",f=$(b).next().text();$(b).hasClass("zmLockLike")||($(b).addClass("zmLockLike"),""!==f&&(f=parseInt(f)),$(b).parent().hasClass("contentILiked")?($(b).parent().removeClass("contentILiked"),e=c.streams.tooltip.likeComment,f-=1,0!==f&&""!==f||$(b).parent().removeClass("contentLiked"),f<=0&&(f="")):($(b).parent().addClass("contentILiked"),e=c.streams.tooltip.unlikeComment,0!==f&&""!==f||$(b).parent().addClass("contentLiked"),f+=1),1===f?$(b).parent().addClass("contentLiked"):0!==f&&""!==f||$(b).parent().removeClass("contentLiked"),$(b).next().show().text(""),$(b).next().show().text(f),zmComponent.tooltip({elm:$(b)[0],text:e,arrow:"top"}),this.model.likeComment(d,$(b)))},showCommentLikes:function(a,b){var c=$(this.$el).find(".zm_lcnt[data-cid='"+a+"']"),d=this.model.pickComment(a).commentObj,e=d.likeList;if($(b).is(c)){var f=zmCont.getOrgContacts(e.join(","),"Array");zmStreamsApp.util.createPopup({items:f,parent:c,ulclass:"SC_Pr",parentClass:"SC_Slke",type:"oneLine"}),$(b).text(e.length)}},sendPrivate:function(a){var b=a.currentTarget,c=$(b).val();if(""!==$.trim(c)&&!$(b).hasClass("zm_snd")){var d=$(b).data("cid"),e=$(b).addClass("zm_snd").data("z");this.model.sendPrivate(c,d,e,function(){
$(b).removeClass("zm_snd")})}},showSingleComment:function(a){var b=$(a).data("cid"),c=this.model.getsinglecomment(b,a,"popup");c&&zmStreamsApp.util.createPopup({items:c,type:"comment",parent:a,ulclass:"rplyCmnt"})},addNewPrivate:function(a){var b=$(a).data("cid"),c=!b,d=c?this.model.get("owner"):$(a).data("z"),e=this.template.createPrivate(b,d,!0,c);c?$(a).children().first().hasClass("pvtRlyLi")||$(a).children().first().before(e):$(a).parents("li").after(e),$(e).find("input").focus(),this.model.get("isDraftShare")&&zmStreamsApp.events.publishKeyEvent(this.model.get("miscData"))},attachReplyTo:function(a){var b=this.$el,c=$(a.currentTarget).data("cid"),d=String($(a.currentTarget).data("z")),e=zmCont.getOrgContacts(d)[d].fn,f=this.template.replyComment(c,e),g=b.parents("ul.Stcmt").find("textArea");if(g.length||(g=b.find("ul.Stcmt textArea")),g.parent().before(f),$(f).data("setHeight",!0).siblings(".zms_rep").remove(),g.data("cid",c).focus(),this.fixedComment){var h=$(b).find(".SCS_cmnt"),i=$(b).find(".SCS_postWra");i.parent().hasClass("SCS_postMail")&&(i=i.parent());var j=i.parents(".SCS_popUp");zmStreamsApp.events.setMaxHeight(j,h[1],i[0])}},updateLike:function(a){var b=this.$el.find('.msi-love[data-cmid="'+a+'"]'),d=this.model.pickComment(a).commentObj,e="";b.removeClass("zmLockLike");var f=d.likes?d.likes:"";d.liked!==b.parent().hasClass("contentILiked")&&(d.liked?(b.parent().addClass("contentILiked"),e=c.streams.tooltip.unlikeComment):(b.parent().removeClass("contentILiked"),e=c.streams.tooltip.likeComment),b.length&&zmComponent.tooltip({elm:b[0],text:e,arrow:"top"})),1===f?$(b).parent().addClass("contentLiked"):0!==f&&""!==f||$(b).parent().removeClass("contentLiked"),b.next().show().text(f)},updPrivateComment:function(a,b,c,d,e){var f,g=this.$el;if(a){$(g).find(".pvtOwn").length&&$(g).find(".pvtOwn").remove(),f=this.model.getPvtComments();var h=this.template.privateToOwner(f,e,"",this.model.get("disableComment")),i=$(this.$el).find(".cmntMore").length?$(this.$el).find(".cmntMore"):$(this.$el).find(".cmnt_ul");$(i).before(h),$(this.$el).parent().find(".SndPrv").hide()}else{f=this.model.getPvtComments(c);var j=$(g).find('.zms_comment[data-cid="'+c+'"]');j.next().hasClass("pvtMsg")&&j.next().remove(),this.template.privateCommentBlock(j,f,!1,"","",this.model.get("disableComment"),!0),j.find(".SndPrv").hide()}},updateMentions:function(){var a=this.model.get("mention"),b=this.$el;"org"!==a&&(a=_.without(a,zmail.zuid),a=zmCont.getOrgContacts(a.join(","),"Array")),document.body.contains(b[0])&&zmAutoFill.updateArray($(b).find("textarea"),a)},reSize:function(){var a=this,b=a.$el,c=$(b).find(".cmnt_ul"),d=a.model.get("disableComment"),e="fixedComment"===$(c).data("type"),f=$(b).find(".SCS_cmnt"),g=$(b).find(".SCS_postWra");e&&!d&&zmStreamsApp.events.setMaxHeight($(b),f[1],g[0])},initialize:function(a){var b=this,c=b.model;b.render(a.postElm,a.highlightComment,a.viewJSON),b.listenTo(c,"change:add",b.addNew),b.listenTo(c,"change:like",b.updateLike,b),b.listenTo(c,"change:listAll",b.listAll),b.listenTo(c,"change:removeComment",b.removeComment),b.listenTo(c,"add:commenttoowner",b.addNewPrivate),b.listenTo(c,"add:privateComment",b.updPrivateComment),b.listenTo(c,"change:getLikes",b.showCommentLikes),b.listenTo(c,"change:singlecomment",b.singlecomment),b.listenTo(c,"change:disableComment",b.disableCommentUpdate),b.listenTo(c,"change:mentionData",b.updateMentions)},render:function(a,d,e){d&&$.isArray(d)&&(d=d[0]);var f=this.model.id,g=this.model.get("attachIndex"),h=e||this.model.toJSON(),i=this.template.comments(h,g,d),j=h.fixedComment;this.fixedComment=j||!1,a?$(a).append(i):a=i;var k,l=$(a).parent().parent();if(j)k=this.template.fixedComment({cid:f,sharedCall:h.sharedCall,sharedApiCall:h.sharedApiCall,entityExists:h.entityExists,totalCount:h.total,isDraftShare:h.isDraftShare,attId:g,isShare:h.isSharedFolder,placeHolder:h.placeHolder,fixedComment:!0,inviteeList:h.inviteeList}),h.disableComment||$(l).append(k),this.$el=$(l);else{this.$el=$(i);var m=$(this.$el).find(".msi-attachment");m.length&&zmComponent.tooltip({elm:m[0],text:c.streams.tooltip.addattachmentComm,arrow:"top"})}var n=h.comments;void 0!==n&&this.setToolTip(n),this.setDefaultEvents(k);var o,p=this.model.get("replyCid"),q=this.model.get("unPost"),r=this.model.get("atmentions"),s=$(a).find("textarea"),t=this.model.get("attachment");if(j&&$(l).length&&(s=$(l).find("textarea")),p){var u=this.model.pickComment(p).commentObj.name,v=this.template.replyComment(p,u);s.data("cid",p).parent().before(v),j&&$(s).focus(),o=this.$el.find(".SC_PUbtm"),$(o).show()}if(q&&($(s).val(q),$(s).data("mentions",r),zmMention.updateElements($(s)),j&&$(s).focus(),o=this.$el.find(".SC_PUbtm"),$(o).show()),t&&t.length>0&&(b=this.model,o=this.$el.find(".SC_PUbtm"),$(o).show(),this.addAttachment(!0)),j&&(a.parent().hasClass("SCS_postMail")&&(a=a.parent()),zmStreamsApp.events.setMaxHeight(l,k,a[0],h.sharedCall,!0)),d)if(this.$el.find(".highlightClass").length){var w=this.$el;setTimeout(function(){var a=w.find(".highlightClass")[0];a.scrollIntoView()},500)}else(!n.length||n.length&&n.length===this.model.get("total"))&&_zm.succErrMsg("e",c.common.messages.commentNotExist);var x=$(a).siblings(".SCS_postWra").length?$(a).siblings(".SCS_postWra"):$(a).find(".SCS_postWra");if(x.length||(x=$(a).filter(".SCS_postWra")),x&&x.find(".SndPrvO").data("commentView",this),this.fixedComment&&this.model.get("sharedCall")&&!this.model.get("entityExists")){var y=this.model.getRecipientsForMail();void 0===y||y.length||this.$el.find(".zm_dIB.zm_inclr").hide()}return $(i).attr("data-commentviewid",this.cid).attr("data-id",this.model.id),this.model.setView(this.cid,this),this},onClose:function(){var a=this;a.fixedComment?(a.undelegateEvents(),a.unbind(),a.stopListening()):a.remove(),a.ComSmiley&&a.ComSmiley.destroy()},removeComment:function(a){var b,c=this.$el,d=c.find('.delCmnt[data-cid="'+a+'"]'),e=$(d).closest("li");!d.length&&$(c).hasClass("SCS_cmnt")&&(e=c.find('.zms_comment[data-cid="'+a+'"]')),b=$(e).next(),$(d).hasClass("delPvtCmnt")&&2===$(e).siblings().length&&(e=$(e).parents("li.pvtMsg"),$(e).prev().find(".SndPrv").show()),e.remove(),$(e).hasClass("zms_comment")&&$(b).hasClass("pvtMsg")&&b.remove(),this.model.get("isDraftShare")&&zmStreamsApp.events.publishKeyEvent(this.model.get("miscData"))},disableCommentUpdate:function(){var a=this,b=a.model,c=a.$el,d=a.template,e=b.get("attachIndex");if(a.fixedComment){if(b.get("disableComment"))$(c).children(".SCS_cmnt").remove();else if($(c).find(".SCS_cmnt").length<=1){var f=d.fixedComment(b.pid);$(c).append(f)}}else{var g=d.comments(b.toJSON(),e);$(c).empty().append(g.children)}b.get("disableComments")||a.setDefaultEvents(c)},setDefaultEvents:function(a){a=a||this.$el;var b=$(a).find("textArea"),c=this.model.get("groupId");!zmCont.isGroup(c)&&this.model.get("shGroup").length&&(c=this.model.get("shGroup")[0].id);var d=zmCont.isGroup(c)?c:"",e={elm:b,resize:!0,mention:this.model.get("mention"),gid:d,addGroups:this.model.get("groupsMention"),isShareFolder:this.model.get("isSharedFolder")};if(this.ComSmiley=zmStreamsApp.Smiley.SmileyAutoComplete({input:b[0],onSelect:function(a,b){var c=this.userInput,d=b.item.attributes.id+" ",e=c.getCurrentTypingWord();c.replaceContentBeforeCursor(e,d)}}),this.model.get("isDraftShare")&&(e.keyCallback=zmStreamsApp.events.publishKeyEvent,e.keyParam=this.model.get("miscData")),this.model.get("sharedCall")&&!this.model.get("isDraftShare")&&this.fixedComment){var f=this;$(b).on("mentions/change",function(a,b){b.zidList&&b.zidList.length&&f.updateInviteeList()})}zmStreamsApp.events.mentionsInput(e),$(a).find(".msi-smiley").click(function(a){zmSmiley.showList(b[0],this,a)});var g=$(a).find(".cmntText")[0];zmLinks.PreviewManager(b[0]).setComponentReadyCallback(function(a){zmStreamsApp.linkPreview.sanitizeComponent(a),$(g).append(a.getDOM())}).setProgressDisplayDOM(g)},getInviteesListForMail:function(){var a=this.$el.find("textArea"),b=$(a).data("mentions")||[],c=this.model.get("inviteeList")||[],d=this.$el.find(".zm_inclr .msi-check").length?this.model.getRecipientsForMail():[];return d.length&&(b=b.concat(d)),c.length&&(b=b.concat(c.join(","))),_.uniq(b)},updateInviteeList:function(){var a=this.getInviteesListForMail();this.template.addInviteeList(zmCont.getOrgContacts(a.join(","),"Array"),this.$el[0])},showInviteeList:function(){var a=this.getInviteesListForMail(),b={items:a,isOwner:!0,showInvite:!0,type:"invitee_popup",invite:!0};b.dialogDidMount=function(a){},b.buttons=[{name:"Add",callback:function(a){zmStreamsApp.util.hideMenu(),a.remove()}},{name:c.common.labels.cancel,callback:function(a){a.remove(),zmStreamsApp.util.hideMenu()},isCancel:!0}],zmStreamsApp.util.createDialog(b)},publish:function(){this.$el.length||(this.$el=this.model.get("fixedElement"));var a=this.$el.find(".lockClass"),b="";a.length&&(b=a.find("i").hasClass("msi-Dinvitee"));var d=this.$el.find("textArea"),g=d.val(),h=zmStreamsApp.util.getMentionData(d),i=this.getEntityAttachment(),j=this.getAttachment(),k=$(this.$el).find(".addcomnt"),l=$(this.$el).find(".zm_inclr i"),m=l.length&&l.hasClass("msi-check")||!1;if(j&&j.error&&1===j.error.code)return!1;if(i&&i.error&&1===i.error.code)return!1;if($.trim(g)&&!$(k).hasClass("zs_snd")){var n=this.model.get("entityExists")===!0?{}:this.model.get("placeHolder"),o=this;$.isEmptyObject(n)?zmStreamsApp.util.sendRemove(k,!1,f):zmStreamsApp.util.sendRemove(k,!1,n.changeText);var p=zmStreamsApp.linkPreview.getLinkInfoFromComponentData(zmLinks.PreviewManager(d).getPreviewData());this.model.NewComment({text:g,mentions:h,replyTo:$(d).data("cid"),attachment:j,attEntObj:i,includeRecipients:m,linkData:p,lockInvites:b,error:function(a,b){if(b=b||{},!b.suppress){var c=a.message||a.msg;zmUtil.succErrMsg("e",c,b)}var d=o.model.get("entityExists")===!0?e:o.model.get("placeHolder").button;zmStreamsApp.util.sendRemove(k,!0,d)}})}else if(""===$.trim(g)){_zm.succErrMsg("e",c.common.messages.emptyComment);var q=this.model.get("entityExists")===!0?e:this.model.get("placeHolder").button;zmStreamsApp.util.sendRemove(k,!0,q)}},clearText:function(a){zmMention.clearMention($(a)),a.data("cid",""),a.val("");var b=$(a).parents(".zms_txtLI");b.length||(b=$(a).parents(".cmntText").siblings(".cmntActions")),zmStreamsApp.util.sendRemove($(b).find(".addcomnt"),!0,e),$(b).find(".zms_rep").remove(),$(b).find(".zm_inclr").remove(),$(b).find(".mailSharedLock").remove(),this.clearAttachment(a,"attach"),zmLinks.PreviewManager(a).reset()},clearAttachment:function(a){var b=$(a).parents("li.zms_txtLI");b.length||(b=$(a).parents(".SCS_cmnt")),$(b).find(".zms_aAtt .zmL").remove(),this.clearFiles()},clearFiles:function(){var a=this;"undefined"!=typeof a.attCmpRef&&""!==a.attCmpRef&&a.attCmpRef.clearStoreAttachments()},addNew:function(a){var b,d,e,f,g,h=_.last(this.model.get("comments")),i=this,j=this.model.get("comments").length,k=this.$el;b=i.template.comment(h,i.model.toJSON());var l=$(b).attr("data-cid");d=$(k).find(".cmnt_ul"),e=$(k).find("textArea"),f=$(d).find(".addcomnt");var m="fixedComment"===$(d).data("type");if(m)g=$(d).last().children().last().attr("data-cid"),g!==l&&$(d).append(b);else{var n=$(d).children();g=$(n).eq($(n).length-2).attr("data-cid"),g!==l&&$(n).last().before(b)}e.val()&&!a&&(this.clearText(e),this.model.set("replyCid",""),this.model.set("unPost",""),this.model.set("atmentions",""),this.model.set("attachment",""));var o=this.model.get("entityExists")===!0?{}:this.model.get("placeHolder");if(o=o||{},o.textArea=o.textArea||c.common.labels.writeComment,o.button=o.button||c.common.comment,e.attr("placeholder",o.textArea),f.text(o.button),!$(this.$el).hasClass("sharedview")||1!==j||this.model.get("isDraftShare")||$(d).siblings(".cmntLabel").length||$(d).parent().prepend(this.template.commentHeader()),this.setToolTip([h]),this.model.get("isDraftShare")&&zmStreamsApp.events.publishKeyEvent(this.model.get("miscData")),h.tags.length){var p=_.pluck(h.tags,"type"),q=p.indexOf("HASHTAG");p.indexOf("HASHTAG")!==-1&&zmStreamsApp.GroupApp.updateHashTag(h.tags[q])}},addAttachment:function(a){var c=this,d=c.$el;b=c.model;var e=d.find("textArea"),f=e.data("attach");if(!d.find(".zms_aAtt").length){var g=$(d).find(".zms_txtLI .cmntText");g.length||(g=$(d).find(".cmntText")),$(g).after(zmStreamsApp.template.addAttachment(f))}var h={id:f};if(c.model.get("isDraftShare")&&(h.share_draft=!0,h.draftID=c.model.get("id"),h.onComponentChange=(c.model.get("miscData")||{}).uploadCallback),a!==!0)h.accId=zmUtil.getDefaultAccountID(),c.attachFiles(f);else{h.accId=zmUtil.getDefaultAccountID();var i=c.callAttachment(f);i.autoLaunch=!1,zmUtil.initAttachComponent(i,function(a){c.attCmpRef=a})}},setToolTip:function(a){var b,d,e,f,g=$(this.$el);if(a=$.isArray(a)?a:[a],a.length)for(var h in a)b=a[h],d=$(g).find('.msi-love[data-cmid="'+b.id+'"]'),d.length&&(e=b.liked?c.streams.tooltip.unlikeComment:c.streams.tooltip.likeComment,zmComponent.tooltip({elm:d[0],text:e,arrow:"top"})),f=$(g).find('.msi-close[data-cid="'+b.id+'"]'),f.length&&zmComponent.tooltip({elm:f[0],text:c.streams.tooltip.delComm,arrow:"top"});if(g.find(".lockClass").length){var i=g.find(".lockClass");zmComponent.tooltip({elm:i[0],text:c.common.labels.allowInvites,arrow:"top"})}},selectMail:function(a,b){var c=this.$el.find("textArea"),d=c.data("selMailIds");d=d||[],"add"===b?d.push(a):d.splice(d.indexOf(a),1),c.data("selMailIds",d);var e=this.$el.find(".selMail");if(!e.length){var f=this.template.selectMailDOM(d.length);c.focus(),e=this.$el.find(".zm_slc").prepend(f)}d.length?e.show().find(".StCnt").text(d.length):e.hide()},listAll:function(a,b,d){var e=this.$el,f=e.find(".cmntMore");if(f.removeClass("zmLock"),$(b).is(f)){var g=_zm.copyOf(this.model.get("comments")),h=e.find(".zms_txtLI"),i=e.find("ul.Stcmt"),j=this.fixedComment,k=h.parents(".SCS_cmnt"),l=i.parents(".SCS_postWra"),m=l.parents(".SCS_popUp");j?$(i[0]).empty():this.model.get("disableComment")?$(i).children().remove():(h.siblings().remove(),h=h.detach());var n=this.model.toJSON(),o=f.data("count"),p=g.length;if(o+10<p&&(g=g.slice(p-(o+10),p)),d){var q,r;for(var s in g)q=g[s].time,r=zmStreamsApp.util.updateTime(parseInt(q)),r&&(g[s].on=r)}if(n.comments=g,this.template.commentList(n,i[0]),j?zmStreamsApp.events.setMaxHeight(m,k[0],l[0]):i.append(h),g.length<10)f.remove();else{var t=this.model.get("total"),u=t-g.length;if(0===u)f.remove();else{var v=e.find(".cmntMore").parent();v.find(".cmntMore").remove(),$(i[0]).prepend(this.template.viewmore(zmText.applyArgs(c.common.labels.viewMoreComments,{count:u}),g[0].id,g.length))}}this.setToolTip(g)}},singlecomment:function(a,b){var c=b.type,d=b.elm;"popup"===c?this.showSingleComment(d):"update"===c&&this.addNew(!0)}}),a}(zmStreamsApp.CommentModule.views);