!function(a){"use strict";var b={},c={},d={},e={},f={},g=[],h=[],i=[],j={},k={},l=[],m=[],n=function(){"undefined"!=typeof zmail.groupObj&&(f=zmail.groupObj.groups||{},g=zmail.groupObj.order||[],k=zmail.groupObj.me||{},delete zmail.groupObj)},o=function(a,c){if(c=c||[],c.constructor!==Array&&(c=[c]),a){b[a]=b[a]||[];var d=b[a];return c.forEach(function(a){a=a||{},d.forEach(function(b,c){b=b||{};var e=!1;b.eid&&a.eid===b.eid&&(e=!0),b.zid&&a.zid===b.zid&&(e=!0),e&&d.splice(c,1)})}),c=c.concat(d),b[a]=c,b[a]}},p=function(a){var b=a.substring(0,1).toLowerCase(),c=/[^a-z]$/;return b.match(c)?"others":b},q=function(a){var c;if(a=[a,""].join(""),b.catlist)for(var d=b.catlist.length,e=0;e<d;e++){c=0;var f=b.catlist[e].cname,g=p(f);g=[g,""].join(""),"500"!==a&&a!==g||(c=1),"general"!==f.toLowerCase()&&1===c&&(b[g]||(b[g]=[]),b[g].push({fn:f+"(List)",cid:b.catlist[e].cid}))}},r=function(a,b){var c=[];return zmUtil.checktype(a,Array)?c[b]=a:(c[b]=[],void 0!==a&&c[b].push(a)),c[b]},s=function(a,f){var g,h=f.clist;if(a=[a,""].join(""),"500"===a){for(g in h)b[g]=o(g,h[g]);if(f.catlist){var i=f.catlist;c.catlist=1,b.catlist=i,q(a)}}else if("100"===a){c[a]=1;for(g in h)d[g]=r(h[g],g);e=f.zlist||{},zmCont.isGroupLoaded()}else c[a]=1,b[g]=o(a,h[a]),q(a)},t=function(a,b){var c=a.clist,d=b.mode;return s(d,a),b.calbk?void b.calbk(d,"callback"):void("cat"===b.type&&zmAutoFill.fillContacts(b.obj,"",c))},u=function(a,b,c){if(a&&f[a]||zmail.zuid===a){var d,e;e=zmail.zuid===a?k:f[a],d=void 0!==c?parseInt(c):parseInt(e.scount),void 0!==c?e.scount=d:b?(d++,e.scount=d):(d--,e.scount=d),$.publish("group/unread",{groupId:a,count:d,incFlag:b})}},v=function(a,b){(b||[]).forEach(function(b){zmCont.GroupAPI.addMember(a,b)})},w=function(){var a=[];if(!m.length){var b,c=_.pluck(zmCont.getGroup(),"members"),d=c.length;for(b=0;b<d;b++)a=a.concat(c[b]);m=_.uniq(a)}return m},x=function(a,b,c){var f=[];a=[a,""].join("");var g=[].concat(d[a]);if(a&&(a.length>1&&"others"!==a&&(a=a.substring(0,1)),void 0!==d[a]))if(f=[],d.val&&d.val===a&&!b)f=d.tmp;else{if(b){var h,i=b.length;for(h=0;h<i;h++)g.indexOf([b[h],""].join(""))!==-1&&g.splice(g.indexOf([b[h],""].join("")),1)}var j,k,l=[],m=w();parseInt(c)&&(l=zmCont.getGroup(c).members);var n;for(l=l.concat(m),l=_.uniq(l),k=0,j=l.length||0,k=j;k>=0;k--)n=g.indexOf(l[k]),n!==-1&&(g.splice(n,1),g.unshift(l[k]));for(j=g.length,k=0;k<j;k++)[g[k],""].join("")!==[zmail.zuid,""].join("")&&f.push(e[g[k]]);d.tmp=f,d.val=a}return f},y=function(a,c){var d=(a.clist[c]||{}).mode,e=c.eid.substring(0,1);d&&!$.isArray(d)&&(d=[d]),d&&d.length?(j[a.qry]&&delete j[a.qry],b[e]&&b[e].length?b[e]=b[e].concat(d):(b[e]=b[e]||[],b[e]=b[e].concat(d))):j[a.qry]=1,c.callbk(a.clist,c)},z=function(a){a=a||{};var b={emailAddress:a.eid,firstName:a.fn||"",lastName:a.ln||"",nickName:a.nn||"",photoURL:a.photo,zohoUserID:a.zid};return b&&b.photoURL&&(b.photoURL+=(b.photoURL.indexOf("?")===-1?"?":"&")+"API=true"),b.displayName=[b.firstName,b.lastName].join(" ").trim()||b.nickName||b.emailAddress,b},A=null,B={},C=function(a){if(B[a])return $.Deferred().reject().promise();if(A||(A=zmail.Utils.DeferredCollection.create({keepDeferreds:!1})),A.has(a))return A.get(a).promise();var b=A.get(a);return zmAjq.XHR({u:zmail.conPath+"/getContacts.do",p:{type:"d",email:a,mode:"200"},fn:function(c){var d=null;if(c=c||{},c.clist=c.clist||{},d=c.clist[200]||[],d.constructor!==Array&&(d=[d]),setTimeout(function(){$.publish("contacts/insert",{contacts:d})},0),d=d.filter(function(b){return b.eid===a}),d[0]){var e=z(d[0]);e._json=d[0],b.resolve(e)}else b.reject()},efn:function(){b.reject()},t:"GET"}),b.fail(function(){B[a]=!0}),b.promise()},D=function(a){var b,c=a.zuid||"",f=a.email||"",g=null,h=null,i=null,j=null;if(f){g="eid",h=f;var k=f.charAt(0).toLowerCase();k=p(k),j=d[k]||[]}else c&&(g="zid",h=c,j=Object.keys(e));for(var l=0;l<j.length;l++){var m=j[l],n=e[m];if(n[g]===h){b=n;break}}return b&&(i=z(b),i._json=b),i},E=function(a){a=a||{};var c,d,e=a.zuid||"",f=a.email||"",g=a.gid||"",h=a.request||!1,i=a.org||!1;if(f){if(i)return D(a);var j=f.charAt(0).toLowerCase();j=p(j);var k=b[j]||[];if(d=k.filter(function(a){return a.eid===f}),d=d[0],d&&d.eid?(c=z(d),c._json=d):(d=void 0,c=d),h&&!c)return C(f)}else if(e){if(i)return D(a);d=zmCont.getOrgContacts(e)||{},d=d[e],!d||d.isDummyObj?(d=void 0,c=d):(c={zohoUserID:e,firstName:d.fn||"",nickName:d.nn||"",emailAddress:d.eid,photoURL:d.photo},c.displayName=c.firstName||c.nickName||c.emailAddress,c._json=d)}else g&&(d=zmCont.getGroup(g),d&&(c={groupID:g,displayName:d.name,photoURL:d.photo,emailAddress:d.eid},g===zmail.zuid&&(c.displayName=zmail.IAMFullName,c.photoURL=zmail.urls.accURL+"/file?fs=thumb&nocache="+Date.now(),c.emailAddress=zmail.user.loginName),c._json=d));if(!f&&c&&c.photoURL&&(c.photoURL+=(c.photoURL.indexOf("?")===-1?"?":"&")+"API=true"),h){var l=$.Deferred();c?l.resolve(c):l.reject(),c=l}return c},F=function(a){a=a||{};var b=[],c=a.limit||null,d=(a.searchKey||"").trim(),f=a.caseSensitive||!1,g=a.sortKey||"",h=a.searchMiddleName||!1,i=a.searchNickName||!1,j=a.ignoreList||[],k={};if(j.forEach(function(a){k[a]=!0}),d){f||(d=d.toLowerCase());var l=[],m=e||{};Object.keys(m).forEach(function(a){l.push(m[a])});for(var n=0,o=l.length;n<o;n++){var p=l[n],q=p.fn||"";f||(q=q.toLowerCase());var r=p.mn||"";f||(r=r.toLowerCase());var s=p.ln||"";f||(s=s.toLowerCase());var t=p.nn||"";f||(t=t.toLowerCase());var u=p.eid||"";f||(u=u.toLowerCase());var v=p.chat||!1,w=0,x=q.indexOf(d);q&&x!==-1&&(w++,0===x&&(w+=10)),h&&r&&r.indexOf(d)!==-1&&w++;var y=s.indexOf(d);s&&y!==-1&&(w++,0===y&&(w+=5)),i&&t&&t.indexOf(d)!==-1&&w++;var z=u.indexOf(d);if(u&&z!==-1&&(w++,0===z&&(w+=8)),w&&v&&w++,w&&!k[p.zid]&&(b.push($.extend({_matchScore:w},p)),c&&b.length>=c))break}return"matchScore"===g&&(b=b.sort(function(a,b){return a._matchScore>b._matchScore?-1:a._matchScore<b._matchScore?1:0})),b}},G=function(a){var b=$.Deferred();return setTimeout(function(){var c=F(a);b.resolve(c)},0),b},H=zmail.Utils.DeferredCollection,I=H.create({keepDeferreds:!1}),J=function(a){a=a||{};var b=(a.searchWord||"").trim().toLowerCase();if(!b)return $.Deferred().reject().promise();var d=b.charAt(0);if(d=p(d),1===c[d])return $.Deferred().reject().promise();var e=I.has(d),f=I.get(d);return e?f.promise():(zmAjq.XHR({u:zmail.conPath+"/getContacts.do",t:"GET",fn:function(a){a=a||{};var b=a.clist||{},e=b[d]||[];o(d,e),c[d]=1,f.resolve()},efn:function(){f.reject()},p:{mode:d,type:"a"}}),f.promise())},K={getContactInfo:E,addGroupmember:v,contacts:function(a,d,e,f){var g,h,i,j=$.Deferred(),k=zmail.conPath+"/getContacts.do";if(a=[a,""].join(""),void 0===d||null===d||c[d]){if("1"===[c[d],""].join("")){var l={};return l.clist=b[d],void(e&&zmAutoFill.fillContacts(e,"",l))}g={mode:a},h={mode:a},"100"!==a||c[100]?"500"!==a&&"300"!==a&&(i=a,"others"!==a&&(i=p(a)),g={mode:i},h={mode:i}):(k=zmail.conPath+"/orgContacts.do",g.mode="orgdata")}else g={mode:a,cId:d},h={mode:d,type:"cat",obj:e};return f&&(h.calbk=f),g.type="a",zmAjq.XHR({u:k,t:"GET",fn:function(){var a=Array.prototype.slice.apply(arguments);t.apply(this,a),j.resolve()},efn:j.reject,p:g,ep:h}),j.promise()},getContact:function(a,d,e,g,h){var i=[],j=[],k=0,l=0,m=0,n=a,o={},q=!1,r=!0,s="";"object"==typeof a&&(void 0!==a.req&&(r=a.req),a.srch&&(s=a.srch),a=a.str,n=a),"others"!==a&&(n=a.substring(0,1),n=p(n)),h&&(q=h.org);var t="100";if(void 0!==q&&q&&1===c[t]){var u=[];h.grpId&&h.grpId!==zmail.zuid&&f[h.grpId]&&(u=f[h.grpId].members),h.list.length>0?u=h.list.concat(u):u.length>0&&(u=u.concat(h.list));var v=h.addtolist?h.groupId:"";if(j=x(n,u,v),v){var w={};parseInt(v)?v=[v]:v.constructor!==Array&&(v=Object.keys(zmCont.getGroup())),v.forEach(function(a){var b=zmCont.getGroup(a);b&&(w[a]=b)});var y={},z={};for(var A in w)z=w[A],y={fn:z.name,nn:"",eid:z.eid,photo:z.photo,zid:A},j.push(y)}}else q&&!c[100]?zmCont.contacts(100):(j=b[n],!c[n]&&r&&(c[n]=2,k=1,zmCont.contacts(a,null,null,g)));e=[e,""].join(""),"s"===e&&1===a.length&&(e="f");var B=function(b){var c=a||"";return b=b||"",!(!c||!b)&&(c=c.toLowerCase(),b=b.toLowerCase(),"f"!==e||'"'!==c.charAt(0)&&"'"!==c.charAt(0)?b.indexOf(c)!==-1:(c=c.substr(1),0===b.indexOf(c)))};if(j){l=j.length;for(var C,D,E,F,G,H,I="",J=0;J<l&&m<d;J++)G=0,H=j[J].name?"name":"fn",""!==s&&B(j[J][s])?G=1:(C=j[J].eid,D=j[J][H],E=j[J].ln,F=j[J].nn,I=[D,E,F].join(" "),C&&B(C)?G=1:D&&B(D)?G=1:E&&B(E)?G=1:F&&B(F)?G=1:B(I)&&(G=1)),1===G&&(j[J].cid||j[J].photo||(j[J].photo=zmail.defaultPhoto),i.push(j[J]),m++)}return o.result=i,1===k&&(o.mc=k),o},consContact:function(a){var b="";return""!==a.fn&&(b+='"fn":"'+zmUtil.quotUnEscape(a.fn)+'"'),a.ln&&""!==a.ln&&(b+=',"ln":"'+zmUtil.quotUnEscape(a.ln)+'"'),a.nn&&""!==a.nn&&(b+=',"nn":"'+zmUtil.quotUnEscape(a.nn)+'"'),a.zid&&""!==a.zid&&(b+=',"zuid":"'+a.zid+'"'),b+=a.photo&&""!==a.photo?',"photo":"'+a.photo+'"':',"photo":zmail.defaultPhoto',""!==b&&(b+=","),b+='"eid":"'+a.eid+'"'},getCateDetails:function(a,d){return b[a]?b[a]:void(2!==c[a]&&"catlist"!==a&&(zmCont.contacts(300,a,null,d),c[a]=2))},isEmailExist:function(a,b,d){if(a){var e,f,g,h=a.substring(0,1),i={str:a,req:!1,srch:"eid"};if(e=zmCont.getContact(i,500,"f"),1===j[a])return{req:!1};if(c[h]||e.result.length||!b||(f={type:"d",email:a,mode:"200"},g={eid:a,callbk:b,mode:"200",elm:d},j[a]=0,l.indexOf(a)<0?(l.push(a),zmAjq.XHR({u:zmail.conPath+"/getContacts.do",t:"GET",fn:y,p:f,ep:g})):b({req:!1},g)),0!==e.result.length)return e.result[0]}},getOrgContacts:function(a,b){var c,d,f,g=a.split(","),h=g.length;for(c="Array"===b?[]:{},d=0;d<h;d++)f=e[g[d]]?e[g[d]]:{g:2,zid:"",nn:"",photo:zmail.defaultPhoto,eid:"",fn:"",isDummyObj:!0},"string"===b?c[g[d]]="{"+zmCont.consContact(f)+"}":"Array"===b?c.push(f):c[g[d]]=f;return c},isGroupLoaded:function(a,b){var d="100";if(c[d]){if(a&&1===c[d])a.apply(null,b);else if(!a&&1===c[d]&&h.length){var e=0,f=h.length;for(e=0;e<f;e++)h[e].apply(null,i[e]);h=[],i=[]}}else zmCont.contacts("100"),a&&(h.push(a),i.push(b))},getContactsForGroup:function(a){var b=[];return a&&(b=zmCont.getOrgContacts(zmCont.getGroup(a).members.join(","),"Array")),b},getGroup:function(a,b){var c={},d=!1;return"undefined"==typeof a?(c=_zm.copyOf(f),d=!0):a===zmail.zuid?(c=_zm.copyOf(k),d=!0):f[a]&&(c=_zm.copyOf(f[a]),d=!0),b&&a!==zmail.zuid&&(c[zmail.zuid]=_zm.copyOf(k),d=!0),d||(c=void 0),c},getGroupOrder:function(){return _zm.copyOf(g)},isGroupMember:function(a,b){var c=f[b];return!(!c||c.members.indexOf(a)===-1)},isGroup:function(a){return a&&"undefined"!=typeof f[a]},getEmailEnabledGroup:function(){var a={},b=f,c=0,d=g.length,e=2;for(c=0;c<d;c++)(zmail.trialUsers||!zmail.trialUsers&&b[g[c]].eid)&&(a[g[c]]=$.extend({},b[g[c]]),a[g[c]].order=e,e++,zmail.trialUsers&&(e=3===c?e+1:e,c>3&&(a[g[c]].hideNode=!0)));return a[k.id]=$.extend({},k),a[k.id].name=zmText.get("zmContacts","common.label.streamsSelfGroup"),a[k.id].order=1,zmail.trialUsers&&d>4&&(a.more={name:"More ..",id:"more",order:6,txtNodeClass:"SC_thm",rowTitle:"View all groups"},a.less={name:"Less ..",id:"less",order:e++,hideNode:!0,txtNodeClass:"SC_thm",rowTitle:"Hide groups"}),a},changeUnread:function(a,b,c){u(a,b,c)},addGroup:function(a,b){f[a]||(f[a]=b,g?g.unshift(a):g=[a],$.publish("group/added",{groupID:a}))},removeGroup:function(a){a&&(g.splice(g.indexOf(a),1),delete f[a])}};K._store={indices:function(){return b},orgIndices:function(){return d},zidList:function(){return e},tempcont:function(){return c},initialize:function(a){a=a||{},b=a.indices||{},d=a.orgIndices||{},c[100]=1,e=a.zidArr||{}}};var L=function(a){a=a||{};var b=a.email,c=a.name||a.email,d=zmail.Utils.EmailValidator;if(b&&d.validate(b).status){var e=p(b),f={eid:b,fn:c};o(e,[f])}},M=function(){var a=$.Deferred(),b=!1,c=!1,d=$.Deferred().resolve(),e=zmCont.contacts(500);zmail.isOrg&&(d=zmCont.contacts(100));var f=function(){b&&c&&a.resolve()};return e.done(function(){b=!0,f()}).fail(function(){_zm.succErrMsg("e","Could not load Personal contacts"),a.reject()}),d.done(function(){c=!0,f()}).fail(function(){_zm.succErrMsg("e","Could not load Organisation contacts"),a.reject()}),a.promise()},N=function(){$.subscribe("compose/addToContacts",function(a,b){L({email:b.email,name:b.name})}),$.subscribe("contacts/insert",function(a,b){b=b||{},b.contacts=b.contacts||[],b.contacts.constructor!==Array&&(b.contacts=[b.contacts]),b.contacts.forEach(function(a){if(a=a||{},a.eid){var b=a.eid.charAt(0);b=p(b),o(b,[a])}})}),$.subscribe("group/member/removed",function(a,b){b=b||{};var c=b.group,d=b.member,e=f[c];e&&(String(e.owner)===String(d)&&(e.owner=-1),zmail.zuid===d&&(e.isOwner=!1))}),$.subscribe("group/moderator/removed",function(a,b){b=b||{};var c=b.group,d=b.moderator,e=f[c];e&&(String(e.owner)===String(d)&&(e.owner=-1),zmail.zuid===d&&(e.isOwner=!1))}),$.subscribe("group/moderator/added",function(a,b){b=b||{};var c=b.group,d=b.moderator,e=f[c];e&&zmail.zuid===d&&(e.isOwner=!0)})},O=function(a,b){var c=f[a];if(!c)return!1;c.members=c.members||[];var d=c.members.indexOf(b);return d===-1&&(c.members.push(b),$.publish("group/member/added",{group:a,member:b}),!0)},P=function(a,b){var c=f[a];if(!c)return!1;c.members=c.members||[];var d=c.members.indexOf(b);return d!==-1&&(c.members.splice(d,1),$.publish("group/member/removed",{group:a,member:b}),!0)},Q=function(a,b){var c=f[a];if(!c)return!1;c.moderator=c.moderator||[];var d=c.moderator.indexOf(b);return d===-1&&(c.moderator.push(b),$.publish("group/moderator/added",{group:a,moderator:b}),!0)},R=function(a,b){var c=f[a];if(!c)return!1;c.moderator=c.moderator||[];var d=c.moderator.indexOf(b);return d!==-1&&(c.moderator.splice(d,1),$.publish("group/moderator/removed",{group:a,moderator:b}),!0)};N(),K.initGroups=n,K.loadContacts=M,K.getOrgContactInfo=D,K.searchORGContacts=F,K.searchORGContactsAsync=G,K.GroupAPI={addMember:O,removeMember:P,addModerator:Q,removeModerator:R},K.fetchContacts=J,a.zmCont=K}(window),function(a){"use strict";var b=zmail.Utils.EmailValidator,c=function(a){a=a||"";var c=b.validate(a);return zmail.debug&&!c.status&&window.console.log("Invalid Email-Address - "+a+" - "+c.errorMessage),c.status},d=function(a,b){b=b||{};var c=/(?:\(([^)]+)\))/gim;a=a||"",a=a.trim(),b.keepHTMLEntity||(a=zmUtil.replaceHTMLEntities(a));var d=zmail.Utils.EmailParser,e=d.parse(a),f=[];return f=e.map(function(a){var b=null,d=a.name;d=d.trim();var e=c.exec(d);e=e?e[1]:"",d=d.replace(c,"");var f={fn:d,eid:a.email,nn:e};return a.valid?(f["class"]="SC_cs",b=zmCont.getContactInfo({email:a.email}),b&&(f.photo=b.photoURL)):(f["class"]="SC_cs zmerr",f.invalid=!0),f})},e=function(a,b){a=a||{},b=b||{};var c="",d=a.firstName,e=a.lastName,f=a.nickName,g="",h=a.email;return d=(d||"").trim(),e=(e||"").trim(),f=(f||"").trim(),d&&(g+=d),e&&(g+=" "+e),f&&(f="("+f+")",g+=" "+f),g=g.trim(),h=(h||"").trim(),h&&(h="<"+h+">"),g?(g='"'+g+'"',c=g+" "+h):c=h,b.keepHTMLEntity||(c=zmUtil.replaceHTMLEntities(c)),c},f=function(a,b,c){return a?(b=b||"object","object"!==b&&(a.ph=a.photo,a.name=a.fn,a.cls=a["class"],a.attr={"data-eid":a.email},a=zmConUtil.bubbleUtil(a,b,c)),a):null},g=function(a,b,c){return a=a||[],a.map(function(a){return f(a,b,c)}),a},h={HEADER:['<li ref="wrapper" class="nohr">',"<div>",'<b ref="name" style="display: block;"></b>','<span ref="email" style="display: inline; vertical-align: middle;"></span>',"</div>",'<div ref="avatarWrapper" class="avatar-wrapper"></div>',"</li>"].join(""),SEPARATOR:['<li class="SC_lne list-separator"></li>'].join(""),LISTITEM:['<li class="list-item"></li>'].join("")},i=function(a){a=a||{};var b=a.dom||a.anchor,c=a.items||[],d=[],e=a.event,f=a.source||"",g=a.email||"",i=a.name||g||"",j=a.zuid||"",k=a.gid||"",l=j||k||a.zid||"";if(e&&zmUtil.stopEvents(e),$(b).length){!g&&$(b).length&&(g=$(b).attr("data-eid"),g=g||""),!l&&$(b).length&&(l=$(b).attr("data-uid")||$(b).attr("z")||$(b).attr("data-zid"),l=l||"");var m=null,n=null,o=null,p=null,q=null;j?q={zuid:j}:k?q={gid:k}:l?zmCont.getContactInfo({gid:l})?(q={gid:l},k=l):(q={zuid:l},j=l):g&&(q={email:g}),m=zmCont.getContactInfo(q),m?m.found=!0:m={found:!1},m=$.extend({displayName:i||g,emailAddress:g},m);var r=zmail.Utils.EmailParser.parse(m.displayName);r=r[0]||{},!m.found&&r.valid&&(m.displayName=r.name||m.displayName);var s=$(h.HEADER),t=_zm.getDOMReferenceMap(s,!0);$(t.name).text(m.displayName),$(t.email).text(m.emailAddress||""),q.displayName=m.displayName,q.type="dom",q.email&&(q.email=m.emailAddress),n=zmail.avatar.get(q),n.done(function(a){o=$(a),$(t.avatarWrapper).prepend(o)}),q.email=m.emailAddress,q.status=zmail.wmsAPI.getPresence(q),p=zmail.wmsAPI.getPresenceIcon(q),p=$(p),$(t.avatarWrapper).append(p);var u=$(h.SEPARATOR);$.publish("contacts/openingCard",{source:f,insertItems:function(a){a=a||[],c=c.concat(a)}}),d.push(s[0]),d.push(u[0]),c.forEach(function(a,b){if(a=a||{},a.id=a.id||"opt_"+b,a.show!==!1&&m[a.show]===a.value){var c=$(h.LISTITEM);c.attr({id:a.id}),c.text(a.htm),"function"==typeof a.clk&&(a.args=a.args||[],m._json||(m._json={eid:g,fn:i,photo:zmail.defaultPhoto}),a.args.unshift(m._json),_zm.bind(c[0],"click",a.clk,a.args)),d.push(c[0])}});var v={par:b,showArrow:!0,liDom:d,ulClass:"SC_P2r",spanClass:"SC_ctdtl"},w=new zmDropDownMenu;if(w.setDropObj(v),w.paint(),g&&!m.found||$("#zms_add").hide(),l){var x=_zm("#","zm_dropDown");_zm.setAttr(x,{zid:l})}}},j=function(a){var b=$.Deferred();a=a||{};var c=a.dom||a.anchor,d=a.email||"",e=a.zuid||"",f=a.gid||"",g=a.zid||"";if(!d&&$(c).length&&(d=$(c).attr("data-eid"),d=d||""),!g&&$(c).length&&(g=$(c).attr("data-uid")||$(c).attr("z")||$(c).attr("data-zid"),g=g||""),g&&zmCont.getContactInfo({gid:g})?f=g:e=g,e&&!d){var h=zmCont.getContactInfo({zuid:e});h&&(d=h.emailAddress)}if(f){var j=zmCont.getContactInfo({gid:f});j&&(d=j.emailAddress)}return d?zmCont.getContactInfo({eid:d,request:!0}).always(b.resolve):b.resolve(),b.always(function(){i(a)}),b.promise()},k={splitncheck:function(a,b,c){var e=d(a);return g(e,b,c)},contactInfo:function(a,b){var c,d,e=a.eid,f=a.zid;if(f){var g=f;c=zmCont.getOrgContacts(g)[g]}else c=zmCont.isEmailExist(e,zmConUtil.fillContDet,b),c&&c.req!==!1||(d=!0,c||(c={}),c.eid=e,c.photo=zmail.defaultPhoto,c.fn="");return c.req===!1&&(d=!1),c&&c.photo&&b&&zmConUtil.fillImgSrc(c.photo,b),{json:c,req:d}},fillImgSrc:function(a,b){var c,d=[];if(b){$.isArray(b)?d=b:d.push(b),c=d.length;for(var e=0;e<c;e++)"IMG"===$(d[e]).get(0).tagName?$(d[e]).attr("src",a):$(d[e]).children("img").attr("src",a)}},fillContDet:function(a,b){var c,d=b.mode,e=a[d],f=b.eid,g=b.elm;if(void 0!==e){if($.publish("contacts/insert",{contacts:e}),$.isArray(e)){for(var h=0;h<e.length;h++)if(e[h].eid===f){c=e[h];break}}else c=e;c.photo&&""!==c.photo&&zmConUtil.fillImgSrc(c.photo,g);var i=c.fn;$("#zms_add").hide(),$("#zms_condet b").html(i)}else $("#zms_add").show()},bubbleUtil:function(){var a='<div class=""><img src="" /><span></span><i class=""></i></div>';return function(b,c){var d,e,f,g,h,i;c=c||{},b=b||{},b.cls=b.cls||"SC_cs",b.attr=b.attr||{},b.eid=b.eid||"",b.ph=b.ph||zmail.defaultPhoto,b.name=b.name||"",b.iclass=b.iclass||"",b.img=b.img||!1,b.ret=b.ret||"string",f=$(a)[0],g=f.childNodes[0],h=f.childNodes[1],i=f.childNodes[2],$(f).attr("class",b.cls),$(f).attr("title",b.eid);for(d in b.attr)$(f).attr(d,b.attr[d]);return $(g).attr("src",b.ph),e=zmUtil.replaceHTMLEntities(b.name),$(h).text(e),$(i).attr("class",b.iclass),b.img||$(g).remove(),b.iclass||$(i).remove(),"function"==typeof c.modifyDOM&&c.modifyDOM({contact:b,dom:f}),"dom"===b.ret?f:"string"===b.ret?f.outerHTML:void 0}}(),loadCompose:function(a,b){zmUtil.hideMenu();var c="";a.fn&&(c+=a.fn),a.ln&&(c+=" "+a.ln),a.eid&&(c+="<"+a.eid+">"),zmUtil.compose({TO:c}),_zm.stopEvents(b)},listMails:function(a){if(a.eid){var b={searchQueryArr:[{lhs:"Sender",contains:!0,value:a.eid}]};zmSearch.addSearch(b),zmUtil.hideMenu()}},listAttachment:function(a){a.eid&&(zmUtil.listAttachmentInAttSearchView({type:"s",srchStr:a.eid}),zmUtil.hideMenu())},createChat:function(a){var b;zmUtil.hideMenu(),"string"==typeof a?b=a:a.zid&&(b=a.zid),b&&zmAjq.XHR({u:zmail.conPath+"/util.do",t:"GET",p:{mode:"createChat",recipient:b}})},checkemail:c,addToContacts:function(a){var b=$.Deferred(),c={mobile:"MOBILE_ph",home:"HOME_ph",work:"WORK_ph",fax:"FAX_ph",others:"OTHERS_PH"};if(a=a||{},a.firstName=a.firstName||"",a.middleName=a.middleName||"",a.lastName=a.lastName||"",a.nickName=a.nickName||"",a.email=a.email||"",a.phone=a.phone||"",a.phoneType=c[a.phoneType]?a.phoneType:"others",!a.email)return b.reject({code:1,msg:zmText.get("zmContacts","utility.message.validEmailNeeded")}),b.promise();a.firstName||a.middleName||a.lastName||(a.firstName=a.email),a.phone||(a.phoneType="");var d={url:"/mail/addContact.do",data:{accId:[zmail.accId,""].join(""),xhr:[Date.now(),""].join(""),zmrcsr:zmAjq.getCookie("zmcsr"),cfN:a.firstName,cmN:a.middleName,clN:a.lastName,cnN:a.nickName,ceA:a.email,cpN:a.phone,cphT:c[a.phoneType]},type:"POST",success:function(c){c=c[0]||{},c=c.zmrsp||"",c=c.replace(/'/gim,""),c?b.resolve({contact:a}):b.reject({code:3,msg:zmText.get("zmContacts","utility.message.contactAvailable")})},error:function(){b.reject({code:2,msg:zmText.get("zmContacts","utility.message.addContactTryAgain")})}};return $.ajax(d),b.promise()},handleAddToContact:function(a,b){a=a||{},_zm.succErrMsg("i",zmText.get("zmContacts","utility.message.addingContact"),{hideAfter:1e3}),zmConUtil.addToContacts({email:a.eid}).done(function(a){a=a||{};var c=a.contact;c&&c.email&&$.publish("contacts/insert",{contacts:[{eid:c.email,fn:c.firstName}]}),_zm.succErrMsg("s",zmText.get("zmContacts","utility.message.addContactSuccess")),$(b.target).fadeOut()}).fail(function(a){a=a||{};var c="e";3===a.code&&($(b.target).fadeOut(),c="i");var d=a.msg||zmText.get("zmContacts","utility.error.unknownError"),e=zmText.get("zmContacts","utility.message.addContactFail",{errorReason:d});_zm.succErrMsg(c,e)})},parseContacts:d,constructContact:e};k.showDet=j,k.showContactCard=j,a.zmConUtil=k}(window),function(){"use strict";var a=zmail.Core.Namespaces,b=a.create("zmail.Integrations.CRM.Contacts"),c=zmail.conPath+"/crm/internal/json/Info/getACRecords",d=3,e=!0,f={},g=zmail.Utils.DeferredCollection.create({keepDeferreds:!1}),h=function(a){var b=$.Deferred();return e?($.ajax({url:c+"?searchWord="+a,type:"post",success:function(a){if(a=a||[],a.constructor!==Array){var c=a.response||{};c.error&&4102===c.error.code&&(e=!1,b.reject())}else b.resolve(a)},error:function(){b.reject()}}),b.promise()):b.reject().promise()},i=function(a,b){a=a||"";var c="";c=a.trim().toLowerCase();var e=!g.has(c),i=g.get(c);return!c||c.length<d?$.Deferred().reject().promise():(b&&(f[c]=null),f[c]?i.resolve(f[c]).promise():(e&&h(c).done(function(a){a=a||[],f[c]=a,i.resolve(a)}).fail(function(){f[c]=[],i.reject()}),i.promise()))},j=function(a){var b=this;a=a||{},b.id=a.id,b._requestDelay=a.delay||1e3,b._searchKey="",b._requestID=null,b._deferred=null};j.prototype.search=function(a,b){var c=this;a=a||"";var e="";return e=a.trim().toLowerCase(),!e||e.length<d?$.Deferred().reject().promise():(0===e.indexOf(c._searchKey)&&(c._deferred&&(c._deferred.reject(),c._deferred=null),clearTimeout(c._requestID)),c._searchKey=e,c._deferred=$.Deferred(),c._requestID=setTimeout(function(){i(a,b).done(function(a){c._deferred.resolve(a)}).fail(function(){c._deferred.reject()})},c._requestDelay),c._deferred.promise())},b.request=i,b.DelayedRequestor=j,b._getCache=function(){return f}}(),zmail.wmsAPI=function(){"use strict";var a={1:"Available",4:"Idle",0:"Offline",3:"Busy",2:"Invisible","-1":"Unapproved"},b={1:"available",2:"invisible",3:"busy",4:"idle",0:"offline"},c=function(){return{UNKNOWN:-2,UNAPPROVED:-1,OFFLINE:0,AVAILABLE:1,INVISIBLE:2,BUSY:3,IDLE:4}},d=function(){return"undefined"!=typeof WmsContacts},e=function(a){var b=null,e=c(),f=e.UNKNOWN;if(a=a||{},!d()||!a.zuid&&!a.gid&&!a.email)return e.UNKNOWN;if(a.email){if(b=zmCont.getContactInfo({email:a.email}),!b||!b.zohoUserID)return e.UNKNOWN;a.zuid=[b.zohoUserID,""].join("")}try{f=WmsContacts.status(a.zuid)}catch(g){f=e.UNKNOWN}return f=parseInt(f),isFinite(f)&&f>-3&&f<5?f:e.UNKNOWN},f=function(a){var b=$.Deferred();return a=a||{},a.email&&zmCont.getContactInfo({email:a.email,request:!0}).always(function(){var c=e(a);b.resolve(c)}),b.promise()},g=function(d){d=d||{};var e=d.status,f=d.zuid||d.gid||d.zid,g=["<i></i>"].join(""),h=c();"undefined"==typeof e&&(e=h.UNKNOWN),e=[e,""].join("");var i=["statusIcon"],j=a[e],k=b[e]||"";i.push(k),i=i.join(" ");var l=$(g);return l.addClass(i),l.attr({title:j}),e!==[h.UNKNOWN,""].join("")&&e!==[h.UNAPPROVED,""].join("")||l.hide(),d.openChatOnClick!==!1&&l.on("click",function(a){_zm.stopEvents(a),zmConUtil.createChat(f)}),l[0]},h={STATUS_CONSTANTS:c(),getPresence:e,getPresenceAsync:f,getPresenceIcon:g,showPresence:function(c,e){if(c=(c||"").trim(),!d()||!c)return null;var f,g=zmail.Utils.EmailValidator.validate(c);if(g&&g.status){var h=zmCont.getContactInfo({email:c});f=h?h.zohoUserID:""}else $.isNumeric(c)&&(f=c);if(f){var i;try{i=WmsContacts.status(f)}catch(j){}$(e).hasClass("SC_avtr")||(e=$(e).find(".SC_avtr"));var k=b[i]||"",l=_zm.getDOM(["I",{attrs:{"class":["statusIcon",k].join(" "),title:a[i]}}]);l=_zm.getDOM(l),e.length&&k&&($(e).after(l),$(l).click(function(a){_zm.stopEvents(a),zmConUtil.createChat(f)}))}}};return h}();