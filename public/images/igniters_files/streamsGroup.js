window.zmStreamsApp=window.zmStreamsApp||Zmail.App.extend({}),zmStreamsApp.GroupApp=function(a){"use strict";var b=zmText.get("streams"),c=a.models,d=a.views,e=zmStreamsApp.constants.notifications;a.GroupId="",a.requestGroupId="";var f="",g=function(a,b,c){var e=new d.Group({model:a});c?$(b).children(":eq(1)").before(e.$el):b.append(e.$el)},h=function(b){var c=zmsuite.getCenter()[0].$el;if(c.find("#viewmembers").text(zmStreamsApp.GroupApp.template("groupMemberText",{grpInfo:zmCont.getGroup(b)})),zmail.trialUsers){if(zmail.trialUsers){var d=zmCont.getGroup(b);d.isOwner?c.find(".msi-add").parents("li").show():c.find(".msi-add").parents("li").hide()}}else{c.find(".SCS_head").remove();var e=a.groupHeader(b);c.find("#s_zm_tabH").prepend(e),a.bindGroupEvents(e,b)}},i=function(a){var b;return a&&c.groups&&(b=_.find(c.groups.models,function(b){return String(b.id)===String(a)})),b},j=function(a,b){var c=i(b.groupId);c&&c.set("unread",b.count)};a.correctUnread=function(a){var b=i(a);b||(zmStreamsApp.GroupApp.init(),b=i(a)),b&&b.correctUnread()},a.emailGroup=function(a){zmUtil.compose({TO:zmCont.getGroup(a).eid})};var k=function(a){var b=zmail.mailLeft.getNodes()[0].getLayer("zmStreamTree");if(b.el.length){var c="grid"===zmAdHocSettings.getStreamsListType(),d={view:"all",gridview:c,addTitleHeader:!0};zmStreamsApp.PostApp.init("",a.id,d,!0,!0,!0)}zmUtil.hideMenu()};a.showDropDown=function(a,b){var c=[];_.each(f,function(a){a&&a.id!==String(b)&&c.push(a)}),zmStreamsApp.util.showGroupDetails({groupInfo:c,elm:a,fn:k})};var l=function(a){if(a){if(c.groups){var b=i(a);c.groups.remove(b),b.trigger("remove")}var d,e="zmStreamTree";d=zmail.mailLeft.getNodes()[0].getLayer(e);var f=d.listObject[a];_.isEmpty(f)||d.deleteNode(d.getRowObj(a)),zmCont.removeGroup(a)}};a.updateGroupListing=function(b){if(c.groups||zmStreamsApp.GroupApp.init(),a.requestGroupId&&c.groups){var d=a.requestGroupId;b?c.groups.sync("getgroups",c.groups).done(function(a){if(a=a[1]){var b=a.list?a.list:a.groups;zmCont.addGroup(d,b[d]);for(var c in b)zmCont.changeUnread(String(c),"",b[c].ucount)}}):l(a.requestGroupId)}};var m=function(a,b){if(c.groups||zmStreamsApp.GroupApp.init(),c.groups){"string"==typeof b.group&&(b.group=$.parseJSON(b.group)),"string"==typeof b.shgroup&&(b.shgroup=$.parseJSON(b.shgroup));var d=b.shgroup||b.group,g=b.ntype,j=[e.mail_type,e.post_mention,e.unshared,e.invite,e.add_post,e.add_comment,e.comment_mention,e.add_task,e.post_group_mention,e.comment_group_mention,e.add_event,e.update_event,e.add_group_member,e.mail_share,e.add_attachment,e.change_task_due_date,e.change_task_assignee,e.change_task_status,e.change_task_priority,e.change_task_category,e.change_task_title,e.change_task_description,e.remove_attachment,e.draft_share,e.draft_shareupdate,e.draft_mailmention,e.mail_share,e.add_link],k=[e.add_comment,e.comment_group_mention,e.comment_mention],l=d.id,m=i(l);if(m){j.indexOf(g)!==-1&&b.nby!==zmail.zuid&&m.trigger("promoteGroup");var n=_.size(b.refList)?b.refList.split(","):[],o=_.find(n,function(a){if(a===zmail.zuid)return!0});if(k.indexOf(g)===-1||b.nby===zmail.zuid||o||m.trigger("commentClass"),g===e.add_group_member||g===e.remove_group_member){var p=g===e.add_group_member,q=p?"addMember":"removeMember",r=p?b.memberzuid.split(","):b.memberzuid;zmStreamsApp.util.groupManagement({mode:q,groupId:m.id,members:r});var s=m.get("members");s=p?s.concat(b.memberzuid):_.without(s,b.memberzuid),m.set("members",s),"zmStreamTree"===zmail.mailLeft.selLayerId&&zmail.mailLeft.selId===l&&zmsuite.getCenter("zm_Container")[0].$el.find("#viewmembers").text(zmStreamsApp.GroupApp.template("groupMemberText",{grpInfo:zmCont.getGroup(l)})),zmsuite.isWorkspaceAvailable("zmStreamsApp")&&zmStreamsApp.GroupApp.getCurrentGroup()===l&&zmsuite.getCenter("zmStreamsApp")[0].$el.find("#viewmembers").text(zmStreamsApp.GroupApp.template("groupMemberText",{grpInfo:zmCont.getGroup(l)})),zmStreamsApp.events.getCurrentGroupId()===l&&h(l)}else g===e.change_moderator&&("Moderator"===b.folder.role?zmStreamsApp.util.groupManagement({mode:"addModerator",groupId:m.id,members:b.memberzuid}):zmStreamsApp.util.groupManagement({mode:"removeModerator",groupId:m.id,members:b.memberzuid}),zmStreamsApp.events.getCurrentGroupId()===l&&b.memberzuid===zmail.zuid&&h(l))}if(zmail.trialUsers&&j.indexOf(g)!==-1&&b.nby!==zmail.zuid&&d.isGroup){var t;t=_.find(f,function(a,b){if(a&&a.id===String(l))return f.splice(b,1),a}),f.splice(1,0,t);var u=zmail.mailLeft.getNodes()[0].getLayer("zmStreamTree"),v=zmList.getRowInfo(l,"zmStreamTree");if(u&&v&&v[l]){v[l].hideNode=!1,u.moveNode(v,void 0,zmail.zuid);var w=$(u.el).find("#more");if(w.is(":visible")&&w.index()>5){var x=$(u.el).find("#more").prev().attr("id");v=zmList.getRowInfo(x,"zmStreamTree"),u.moveNode(v,void 0,"more"),u.hideNode(x)}}}}};"undefined"!=typeof zmNCenter&&zmNCenter.handlers.add("streams",m);var n=function(a){var b,c,d="zmStreamTree";b=zmail.mailLeft.getNodes()[0].getLayer(d),c=zmCont.getGroup(a),b.listObject[a]=c;var e=zmList.getRowInfo(c.id,d);e[c.id].hideNode=!1,b.insertNodeAfter(e,b.listObject,zmail.zuid)};$.subscribe("group/added",function(a,b){var e=zmCont.getGroup(b.groupID);if(c.groups||zmStreamsApp.GroupApp.init(),c.groups){var h=c.groups.add(e);if(g(h,d.groupHolder,!0),zmail.trialUsers){var i=e.scount;e.scount=i?i:0,f.splice(1,0,e),n(h.id)}}}),$.subscribe("group/streamsmailincluded",function(a,b){b.id&&n(b.id)}),$.subscribe("group/streamsdisabled",function(a,b){b.id&&l(b.id)}),a.getCurrentGroup=function(){return a.GroupId},a.getAllUnread=function(){c.groups||zmStreamsApp.GroupApp.init(),c.groups.updateUnread()},a.updateHashTag=function(a,b){b=b||String(zmail.zuid);var c=i(b);c||(zmStreamsApp.GroupApp.init(),c=i(b));var d=a.text;d=d.indexOf("#")!==-1?d.substring(1):d,c.updateHashTagforAutofill(d)},a.init=function(e,h){d.groupHolder=e;var j=zmCont.getGroupOrder(),k=zmail.zuid;j.indexOf(k)===-1&&j.unshift(k);var l={list:zmCont.getGroup(void 0,!0),order:j};if(_.each(l.list,function(a,c){a.id===zmail.zuid&&(a.name=b.common.labels.home,a.photo=zmCont.getOrgContacts(zmail.zuid)[zmail.zuid].photo,a.scount=a.scount)}),f=zmStreamsApp.util.orderComments(l.list,l.order),void 0===c.groups)c.groups=new c.GroupCollection(l,{parse:!0});else{var m,n=l.list;_.each(n,function(a){m=i(a.id),m&&m.set("scount",a.scount)})}var o=c.groups;if(e){if(e.children().length||o.each(function(a){g(a,e)}),h){var p=a.getModel(h);p&&p.trigger("loadPost")}else $(e).children().first().click();"undefined"!=typeof zmNCenter&&zmNCenter.icon.defaultStreamIcon()}a.fetchHashTags()},$.subscribe("group/unread",j),a.markAllRead=function(a){var b=i(a);b||(zmStreamsApp.GroupApp.init(),b=i(a)),b&&b.markPostsRead("markallread",b,{}),zmCont.isGroup(zmStreamsApp.events.getCurrentGroupId())&&zmStreamsApp.PostApp.markPostRead(a)},a.getModel=function(a){var b=i(a);return b||(zmStreamsApp.GroupApp.init(),b=i(a)),b},a.clearTags=function(a,b){a=a||zmail.zuid,b=b||"trendingtags";var c=i(a);c||(zmStreamsApp.GroupApp.init(),c=i(a));var d=c.get("type");d&&c.unset(b)},a.bindGroupEvents=function(a,c){var d=a?$(a).find(".SCS_groupInfo"):zmsuite.getCenter()[0].$el,e=$(d).find(".zms_addMem"),f=$(d).find("#viewmembers"),g=$(d).find(".gdrop"),h=$(d).find("#createChat"),i=$(d).find("#geid");e.length&&$(e).click(function(){zmStreamsApp.GroupApp.addMember(c)}),f.length&&$(f).click(function(){var a={gid:c,callback:zmStreamsApp.events.loadPostsOfUsers};zmStreamsApp.GroupApp.showMemberDialog(a)}),g.length&&$(g).click(function(){zmStreamsApp.GroupApp.showDropDown(g,c)}),h.length&&(zmComponent.tooltip({elm:h[0],text:b.streams.tooltip.chat,arrow:"top"}),$(h).click(function(){zmStreamsApp.GroupApp.createGroupChat(c)})),i.length&&$(i).click(function(){zmStreamsApp.GroupApp.openCompose(c)})},a.groupHeader=function(a){var c=zmStreamsApp.GroupApp.template("group_header",a),d=zmail.zuid===a;if(c&&!d&&zmCont.getGroup(a).isOwner){var e=$(c).find(".zms_addMem");e&&e.length&&zmComponent.tooltip({elm:e[0],text:b.common.labels.addNewMember,arrow:"top"})}return c},a.fetchHashTags=function(a,b,c){if(a=a||zmail.zuid,zmCont.getGroupOrder().length){var d=i(a);if(d||(zmStreamsApp.GroupApp.init(),d=i(a)),d)return d.getHashTags(b,c)}return[]};var o=function(a,c){var d="add"===c?b.common.messages.membersAdded:c;zmUtil.succErrMsg("s",d),h(a)},p=function(a,c){var d,e,f=a.gid,g=$(c.$els.$content).find("ul.zm_action"),h=$(c.$els.$content).find("li.loadPost");for(e=0;e<g.length;e++)d=g[e],d&&zmComponent.tooltip({elm:d,text:b.groupSubscription.memberActions.mreact,arrow:"top"});for(e=0;e<h.length;e++)d=h[e],d&&$(d).find("strong").attr("title",b.groupSubscription.memberActions.loadPost);$("ul.viewMem").off("click").on("click",function(b){var d=$(b.target).parents("li");if(d&&d.hasClass("loadPost")&&a.callback){var e={zid:d.data("id"),dialog:c,gid:f};a.callback(e)}}),$(c.$els.$content).off("scroll").on("scroll",function(){zmStreamsApp.util.hideMenu()}),$("ul.zm_action").off("click").on("click",function(a){a.stopPropagation(),$(a.currentTarget).parent().addClass("show");var d,e,g,h=[],j=i(f);j||(zmStreamsApp.GroupApp.init(),j=i(f)),j&&(e=j.get("moderator"));var k=$(a.currentTarget).parents(".zm_mem_post"),l=String(k.data("id")),m=zmCont.getOrgContacts(l)[l].fn,n=e.indexOf(l)!==-1;g=n?b.groupSubscription.memberActions.makemem:b.groupSubscription.memberActions.makeadmin,h.push({txt:g,data:"changeAdmin"}),h.push({txt:b.groupSubscription.memberActions.remmember,data:"removeMem"});var p=function(e,g,h){if(zmStreamsApp.util.hideMenu(),"changeAdmin"===e.item){if(j){var i;i=n?"removeModerator":"addModerator",d=function(){var c="";"addModerator"===i?(k.find("i.SC_Otxt").text(b.common.labels.moderator),c=zmText.applyArgs(b.groupSubscription.memberActions.modSuccess,{member:m})):"removeModerator"===i&&(k.find("i.SC_Otxt").text(""),c=zmText.applyArgs(b.groupSubscription.memberActions.modRemove,{member:m})),$(a.currentTarget).parent().removeClass("show"),zmUtil.succErrMsg("s",c)},j.changeModerator({mode:i,zuid:l},d)}}else"removeMem"===e.item&&(d=function(){var a=zmStreamsApp.GroupApp.template("groupMemberText",{grpInfo:zmCont.getGroup(f),isAllow:!0});$(c.$els.$contentWrapper).find("#isMem").text(a),k.remove(),o(f,zmText.applyArgs(b.groupSubscription.memberActions.memRemove,{member:m}))},j&&j.removeMember(l,d))};zmStreamsApp.util.createPopup({items:h,parent:$(a.currentTarget).find("b"),parentClass:"SC_Sopt",type:"oneLine",noArrow:!0,avoidScroll:!0,align:"pright",hoverElm:$(a.currentTarget).find("b"),container:c.$els.$contentWrapper[0],onhide:function(){$(a.currentTarget).parent().removeClass("show")},callback:p})})},q=function(a){var c=a.content,d=a.textValue,e=a.gid,f=a.breakPoint,g=a.dialog,h=zmCont.getGroup(e),j=zmStreamsApp.util.membersFilter(e,d),k=c.find(".viewMem");k.html("");var l=zmStreamsApp.GroupApp.template("viewmembers",{members:j,owner:h.owner,moderator:h.moderator});if(k.append(_zm.getDOM(l)),h.isOwner){var m=zmCont.searchORGContactsAsync({searchKey:d,limit:10,ignoreList:h.members});c.find("br").remove(),k.after(f),m.done(function(d){if(d&&d.length){var f=d.length,h=f+(1===f?" "+b.common.labels.match:" "+b.common.labels.matches);c.find(".isAddCount").text(h),c.find("#isAdd").show(),k=c.find(".addMem"),k.html(""),l=zmStreamsApp.GroupApp.template("viewmembers",{members:d,isAdd:!0,gid:e}),k.append(_zm.getDOM(l)),k.show(),$(g.$els.$content).find(".addButton").off("click").on("click",function(){var d=$(this),j=$(this).find("span");if(!$(this).hasClass("zmLock")){var k=$(this).parents("li");j.text(b.groupSubscription.memberActions.adding),$(this).addClass("zmLock");var l=i(e);l||(zmStreamsApp.GroupApp.init(),l=i(e));var m=k.data("id");if(l){m=String(m);var n=function(){var d=zmCont.getGroup(e),i=zmStreamsApp.GroupApp.template("getLIView",{contactObj:zmCont.getOrgContacts(m)[m],mod:"",info:d}),j=$("ul.viewMem").children();j&&1===j.length&&$(j[0]).hasClass("nohr")&&$("ul.viewMem").html(""),$("ul.viewMem").append(_zm.getDOM(i)),h=zmStreamsApp.GroupApp.template("groupMemberText",{grpInfo:d,isAllow:!0}),f-=1,c.find("#isMem").text(h),h=f+(1===f?" "+b.common.labels.match:" "+b.common.labels.matches),$(g.$els.$contentWrapper).find(".isAddCount").text(h),k.siblings().length||(k.parent().prev().remove(),k.parent().remove()),k.remove(),o(e,"add"),p(a.eparam,g)},q=function(){j.text(b.groupSubscription.memberActions.addButton),d.removeClass("zmLock")};l.addMember(m.split(","),n,q)}}})}else c.find("#isAdd").hide(),c.find(".addMem").hide()})}p(a.eparam,g)},r=function(a){var b=["H3",{child:[["text",a]]}];return _zm.getDOM(b)};a.showMemberDialog=function(a){var c=a.gid;if(c&&(!zmsDialog.elemId||"zms_memView"!==zmsDialog.elemId)){var d=zmCont.getGroup(c),e=zmCont.getOrgContacts(d.members.join(",")),f=_zm.getDOM(["BR",{}]),g=zmStreamsApp.GroupApp.template("popupConstruction",{members:e,owner:d.owner,moderator:d.moderator}),h={ignoreMouseDown:!1,$content:$(g),closeAction:function(){},dialogDidMount:function(e){var g,h=e.$els,i=h.$header,j=$(h.$content),k=zmStreamsApp.GroupApp.template("groupMemberText",{grpInfo:d,isAllow:!0});j.prepend(zmStreamsApp.GroupApp.template("memberHeader",{name:k,members:d.members})),j.css("max-height",.7*$(window).height()),p(a,e),$(i).append(r(d.name));var l=$(h.$content).get(0).scrollHeight>$(h.$content).height();if(l||d.isOwner){$(h.$positionWrapper).addClass("SC_PopTop");var m="40px";$(h.$positionWrapper).css("top",m);var n=zmStreamsApp.GroupApp.template("searchBox",{isOwner:d.isOwner});$(i).append(n),$(n).find("input").css("width","400px");var o=zmStreamsApp.GroupApp.template("memberHeader",{name:b.groupSubscription.memberActions.addGroupTitle,mode:"isAdd"});j.append(o),j.append(zmStreamsApp.GroupApp.template("popupConstruction",{isAdd:!0,gid:c})),g=function(b){return 13!==b.keyCode&&(27===b.keyCode?(e.remove(),!1):void q({content:j,grpInfo:d,gid:c,breakPoint:f,textValue:$(n).find("input").val(),dialog:e,eparam:a}))},$(n).find("input").off("keyup").on("keyup",g),$(n).find("input").focusin(function(){$(this).parent().addClass("inputFocus")}).focusout(function(){$(this).parent().removeClass("inputFocus")}),$(n).find("input").focus()}}};Dialog["new"](h)}};var s=function(a,b){var c=_zm("<","input",_zm("#","zms_AMember"))[0],d=zmAutoFill.getAddress(c),e=0,f=d?d.length:0,g=[];for(e=0;e<f;e++)g.push(d[e].zid);var h=i(a);if(h||(zmStreamsApp.GroupApp.init(),h=i(a)),g.length&&h){var j=function(){b(),o(a,"add")};h.addMember(g,j)}};return a.createGroupChat=function(a){var b=i(a);b||(zmStreamsApp.GroupApp.init(),b=i(a)),b.sync("createChat",b,{})},a.openCompose=function(a){var b=i(a);b||(zmStreamsApp.GroupApp.init(),b=i(a)),zmUtil.compose({TO:zmCont.getGroup(b.id).eid})},a.addMember=function(a){var c=zmStreamsApp.GroupApp.template("addMember"),d=_zm.getDOM(c);_zm.remove(_zm("#",d.id)),zmsuite.getCenter()[0].getNodes()[1].$el[0].parentElement.appendChild(d);var e=zmCont.getGroup(a).name,f=function(){zmsDialog.remove(),_zm.remove(_zm("#",d.id))},g={style:{width:"600px"},title:b.common.labels.addNewMember+" - "+e,mask:!0,hideclose:!1,pos:"center",buttons:[{txt:b.common.labels.add,callback:function(){s(a,f)}},{txt:b.common.labels.cancel,isCancel:!0,callback:f}]};zmsDialog.create(d.id,g);var h=_zm("<","input",d)[0],i={contentArray:"org:"+a,compare:["fn","ln","nn","eid"],LType:"3",OType:"2",eliminateAt:!0};zmAutoFill.setAutofill(i,$(h)),setTimeout(function(){h.focus()},700)},a.showtrendingTags=function(a,b){var c=i(b);c||(zmStreamsApp.GroupApp.init(),c=i(b)),c.getHashTags("trendingtags",function(){var b=c.get("trendingtags");zmStreamsApp.util.createPopup({items:b,parent:a,type:"trendingtags",liHover:!1,parentClass:"SC_tTags",callback:function(a,b){var c=$(b).data("text");if(zmStreamsApp.util.hideMenu(),c){var d=zmStreamsApp.events.getCurrentView(),e=zmStreamsApp.PostApp;e.showOtherTab("#"+c,"hashTag",c,zmStreamsApp.events.getCurrentGroupId()),e.fetchPosts({type:"other",ele:d.elm,previous:d.tab})}}})})},a}(zmStreamsApp.GroupApp||Zmail.App.extend({})),window.zmailStreamsApp=window.zmailStreamsApp||Zmail.App.extend({}),zmailStreamsApp.GroupApp=function(a){"use strict";return a}(zmailStreamsApp.GroupApp||Zmail.App.extend({})),zmailStreamsApp.GroupApp.constants=function(a){"use strict";a=a||{},a.methods={correctUnread:"correctUnread",createchat:"createGChat",getAllUnread:"getAllUnread",getGroups:"groups"}}(zmailStreamsApp.GroupApp.constants),window.zmStreamsApp=window.zmStreamsApp||Zmail.App.extend({}),zmStreamsApp.GroupApp=function(a){"use strict";return a}(zmStreamsApp.GroupApp||Zmail.App.extend({})),zmStreamsApp.GroupApp.models=function(a){"use strict";return a.Group=Zmail.Model.extend({defaults:{ladt:"",name:"",owner:"",ucount:"",users:""},markPostsRead:function(){var a=this;this.sync("markallread",this).done(function(){zmCont.changeUnread(a.id,"",0),zmStreamsApp.events.clearList(a.id)})},addMember:function(a,b,c){var d=this;this.sync("addmember",this,{zuid:a}).done(function(){zmStreamsApp.util.groupManagement({mode:"addMember",groupId:d.id,members:a});var c=d.get("members");c=c.concat(a),d.set("members",c),b()}).error(function(){c&&c()})},removeMember:function(a,b){var c=this;this.sync("removeMember",this,{zuid:a}).done(function(){zmStreamsApp.util.groupManagement({mode:"removeMember",groupId:c.id,members:a});var d=c.get("members");d=_.without(d,a),c.set("members",d),b()})},changeModerator:function(a,b){var c=this,d=a.zuid;this.sync("changeModerator",this,a).done(function(){zmStreamsApp.util.groupManagement({mode:a.mode,groupId:c.id,members:d});var e=c.get("moderator");"addModerator"===a.mode?e=e.concat(d):"removeModerator"===a.mode&&(e=_.without(e,d)),c.set("moderator",e),b()})},updateHashTagforAutofill:function(a){var b=this.getHashTags("loadhashtags"),c=_.pluck(b,"name");c.indexOf(a)===-1&&(b.push({name:a}),this.set("loadhashtags",b))},getHashTags:function(a,b,c){var d=this;a=a||"loadhashtags";var e=d.get(a);return e?"request"===e?[]:(b&&b(e),e):(d.set(a,"request"),void this.sync("fetchTags",this,{actionType:a,startsWith:c}).done(function(c){var e=c[1].hashTags,f=[];return _.each(e,function(a){f.push({name:a})}),e.length||(f=[]),d.set(a,f),b&&b(f),this}).error(function(){d.set(a,"request")}))},correctUnread:function(){var a=this;this.sync("correctUnread",this).done(function(b){var c=b[1].count;void 0!==c&&zmCont.changeUnread(a.id,"",c)})},url:"/zm/stream.do",serialized:function(a,b){var c=this,d=null;return"correctUnread"===a?d={actionType:"viewGroupData",streamsView:!0,mode:"correctUnread",groupId:c.get("id")}:"createChat"===a?(d={mode:"createGroupChat",groupId:c.get("id")},b.url=zmail.conPath+"/util.do",b.type="GET"):"markallread"===a?(d={groupId:c.get("id"),actionType:"markallAsRead",mode:"markallread",streamsView:!0},b.url=zmail.conPath+"/post.do"):"addmember"===a?(d={gid:c.get("id"),mode:"addMember",mzuid:b.zuid},b.url=zmail.conPath+"/groupSubscription.do"):"fetchTags"===a?(d={groupId:c.get("id"),actionType:b.actionType||"loadhashtags",mode:"hashTags",streamsView:!0},b.startsWith&&(d.startsWith=b.startsWith,d.actionType="autocomplete")):"removeMember"===a?(d={gid:c.get("id"),mode:"removeMember",mzuid:b.zuid},b.url=zmail.conPath+"/groupSubscription.do"):"changeModerator"===a&&(d={gid:c.get("id"),mode:"changeRole",mzuid:b.zuid,moderator:"addModerator"===b.mode},b.url=zmail.conPath+"/groupSubscription.do"),d}}),a.GroupCollection=Zmail.Collection.extend({model:a.Group,url:"/zm/stream.do",addModel:function(a,b,c){return this.remove(a,{silent:c}),this.add(a,{at:b,silent:c}),this},updateUnread:function(){this.sync("getAllUnread",this).done(function(a){a=a[1];var b;for(b in a)zmCont.changeUnread(String(b),"",a[b])})},serialized:function(a,b){var c=null;return"getgroups"===a?(b.url=zmail.conPath+"/getGroups.do",c={mode:"groups"}):"getAllUnread"===a&&(c={mode:"allucount"}),c},parse:function(b){var c=b.list?b.list:b.groups,d=b.order;return a.groupOrder=d,_(d).map(function(a,b){var d=c[a];return d.sequence=b+1,d})}}),a}(zmStreamsApp.GroupApp.models),zmStreamsApp.GroupApp.template=function(){"use strict";var a=zmText.get("streams"),b=150,c=function(b){if(b){var c=b>99?a.common.labels.above99:b;return c}},d=function(b){var d=b.id,e=d===zmail.zuid,f=e?a.common.labels.home:b.name,g=b.scount||0,h=e?zmCont.getOrgContacts(d)[d].photo:zmCont.getGroup(d).photo,i="zmFrm"+(g>0?" SC_bld":""),j=c(g);_zm.preloadimg(h);var k=b.members&&!e?b.members.length:0,l=[];if(!e){var m=b&&b.eid?["I",{attrs:{"class":"msi-mail"}}]:[],n=e?[]:["I",{attrs:{"class":"msi-chat"}}],o=k+(1===k?" "+a.common.labels.person:" "+a.common.labels.members);l=["DIV",{attrs:{"class":"zmSub"},child:[["SPAN",{attrs:{"class":"sum"},child:[["text",o]]}],n,m]}]}var p=["DIV",{attrs:{"class":"zmL SC_strm"},child:[["DIV",{attrs:{"class":"zmLst"},child:[["DIV",{attrs:{"class":"zmDtl"},child:[["DIV",{attrs:{"class":"zmImg",title:f},child:[["IMG",{attrs:{src:h}}]]}],["DIV",{attrs:{"class":i},child:[["SPAN",{child:[["text",f]]}]]}],l,["DIV",{attrs:{"class":"zm_lbl",style:b.scount>0?"":"display:none"},child:[["text",j]]}]]}]]}]]}];return _zm.getDOM(p)},e=function(b,c){var d="",e=b.members;return e&&(e=e.length,d=zmail.trialUsers||c?"isAdd"!==b.mode?e+(1===e?" "+a.common.labels.person:" "+a.common.labels.members):e+(1===e?" "+a.common.labels.match:" "+a.common.labels.matches):zmText.applyArgs(a.common.labels.viewMembers,{memberLen:e})),d},f=function(a){var c=a.members,d=c.length,f=[],g=0,h=d>5?5:d,i=zmCont.getOrgContacts(c.join(",")),j="";for(g=0;g<h;g++)j=i[c[g]].photo,f.push(["IMG",{attrs:{src:j}}]);var k=a.isOwner&&d<b?"":"display:none",l=["LI",{attrs:{style:k},child:[["I",{attrs:{"class":"msi-add zms_addMem"}}]]}],m=["DIV",{attrs:{"class":"SCS_groupInfo"},child:[["UL",{child:[["LI",{child:f}],l]}],["FONT",{attrs:{"class":"SC_lnk",id:"viewmembers"},child:[["text",e(a)]]}]]}];return m},g=function(a){var b=a===zmail.zuid,c=b?zmCont.getOrgContacts(a)[a]:zmCont.getGroup(a),d=c.photo||"images/SC-Photo.png",e=c.name||c.fn,g=c.desc||"",h=b?[]:f(c),i=["DIV",{attrs:{"class":"SCS_head"},child:[["IMG",{attrs:{src:d}}],["H3",{child:[["text",e]]}],["P",{child:[["text",g]]}],h]}];return _zm.getDOM(i)},h=function(b,c,d){var e=["DIV",{attrs:{"class":"SC_avtr"}}],f=[],g=d.moderator,h=d.owner;zmail.avatar.get({zuid:b.zid,type:"template",displayName:b.fn}).done(function(a){e=a}),f=g&&g.indexOf(zmail.zuid)!==-1&&b.zid!==zmail.zuid&&b.zid!==String(h)?["DIV",{attrs:{"class":"SCmb"},child:[["UL",{attrs:{"class":"zm_action"},child:[["LI",{attrs:{"class":""},child:[["B",{child:[["I",{attrs:{"class":"msi-action"}}],["DIV",{attrs:{"class":"SC_hd"}}]]}]]}]]}]]}]:[];var i=d.isAdd?[]:["I",{attrs:{"class":"SC_Otxt"},child:[["text",c]]}],j=d.isAdd?["DIV",{attrs:{"class":"SC_PUbtm addButton"},child:[["SPAN",{child:[["text",a.groupSubscription.memberActions.addButton]]}]]}]:["SPAN",{child:[["text",b.eid]]}],k=d.isAdd?"":"loadPost",l=["LI",{attrs:{"data-id":b.zid,"class":"zm_mem_post "+k},child:[e,["DIV",{child:[["STRONG",{child:[["text",b.fn]]}],i,j]}],f]}];return l},i=function(b){var c,d,e,f,g,i=b.members,j=b.owner,k=b.moderator,l=b.gid,m=[],n=0,o=[],p=[];if(!b.isAdd&&_.size(i)){for(n in i)d=i[n],d.fn&&(g=k.indexOf(d.zid)!==-1,f=g?a.common.labels.moderator:"",c=d.zid===String(j)?a.common.labels.owner:f,e=h(d,c,b),c===a.common.labels.moderator?o.push(e):c===a.common.labels.owner?p.push(e):m.push(e));m=p.concat(o).concat(m)}else if(b.isAdd&&_.size(i))for(n=0;n<i.length;n++)d=i[n],zmCont.isGroupMember(d.zid,l)||(e=h(d,"",b),m.push(e));else m=[["LI",{attrs:{"class":"nohr",style:"padding-left: 0px;text-align: center;padding-right: 0px;"},child:[["SPAN",{child:[["text",a.common.labels.nomemfound]]}]]}]];return m},j=function(a){var b=[];a.members&&(b=i(a));var c=a.isAdd?"addMem":"viewMem SC_PhrTxt",d=a.isAdd?"display : none":"",e=["UL",{attrs:{"class":"SC_P2r P2rBlkGery "+c,id:"zms_memView",style:d},child:b}];return _zm.getDOM(e)},k=function(a,b,c,d,e){var f=[["DIV",{attrs:{"class":"SCS_rgtIn",id:"zm_tabH"}}],["DIV",{attrs:{"class":"SCS_rgtIn",id:"gridView"}}],["DIV",{attrs:{id:"listView"}}]];f[b?2:1][1].attrs.style="display:none",f=_zm.getDOM(f);var g=$(f).children()[0];g.appendChild(zmStreamsApp.updateBoxTemplate.updatebox(a,c,d,e));var h=["DIV",{attrs:{id:"gunrd"}}],i=["DIV",{attrs:{id:"gmntn"}}],j=["DIV",{attrs:{id:"gall"}}],k=["DIV",{attrs:{id:"gother"}}],l=["DIV",{attrs:{id:"gfav"}}],m=["DIV",{attrs:{id:"gallfeeds"}}],n=$(f).children()[1];n.appendChild(_zm.getDOM(h)),n.appendChild(_zm.getDOM(i)),n.appendChild(_zm.getDOM(j)),n.appendChild(_zm.getDOM(l)),n.appendChild(_zm.getDOM(k)),h=["DIV",{attrs:{id:"lunrd"}}],i=["DIV",{attrs:{id:"lmntn"}}],j=["DIV",{attrs:{id:"lall"}}],l=["DIV",{attrs:{id:"lfav"}}],k=["DIV",{attrs:{id:"lother"}}];var o=$(f).children()[2];if(o.appendChild(_zm.getDOM(h)),o.appendChild(_zm.getDOM(i)),o.appendChild(_zm.getDOM(j)),o.appendChild(_zm.getDOM(l)),o.appendChild(_zm.getDOM(k)),a){zmail.showFeature&&(n.appendChild(_zm.getDOM(m)),m=["DIV",{attrs:{id:"lallfeeds"}}],o.appendChild(_zm.getDOM(m)));var p=["DIV",{attrs:{id:"gbyme"}}];n.appendChild(_zm.getDOM(p)),p=["DIV",{attrs:{id:"lbyme"}}],o.appendChild(_zm.getDOM(p))}return f},l=function(){return _zm.getDOM(["I",{attrs:{"class":"msi-lcmnt"}}])},m=function(b){var c=b.isOwner?a.groupSubscription.memberActions.searchModerator:a.groupSubscription.memberActions.searchUser,d=["DIV",{attrs:{"class":"SC_sch"},child:[["I",{attrs:{"class":"msi-search"}}],["INPUT",{attrs:{type:"text",placeholder:c}}]]}];return _zm.getDOM(d)},n=function(a){var b=[];if(a){var c="isAdd"===a.mode,d=c?["DIV",{attrs:{"class":"SC_SDot"}}]:[],f=c?"isAdd":"isMem",g=c?"display : none":"",h=c?["SPAN",{attrs:{"class":"memText isAddCount"},child:[["text",e(a,!0)]]}]:[];b=["H4",{attrs:{id:f,style:g},child:[["text",a.name+" "],d,h]}]}return _zm.getDOM(b)},o=function(){var b=["DIV",{attrs:{id:"zms_AMember"},child:[["DIV",{attrs:{"class":"SC_input",id:"zms_invPop",style:"width:calc(100% - 2px);"},child:[["INPUT",{attrs:{type:"text","class":"zm_sgst",placeholder:a.common.labels.addNewMember}}]]}]]}];return b};return function(a,b){var f;return"groupList"===a?f=d(b):"postHolder"===a?f=k(b):"group_header"===a?f=g(b):"viewmembers"===a?f=i(b):"unreadText"===a?f=c(b):"commentClass"===a?f=l():"addMember"===a?f=o():"groupMemberText"===a?f=e(b.grpInfo,b.isAllow):"searchBox"===a?f=m(b):"memberHeader"===a?f=n(b):"getLIView"===a?f=h(b.contactObj,b.mod,b.info):"popupConstruction"===a&&(f=j(b)),f}}(),window.zmStreamsApp=window.zmStreamsApp||Zmail.App.extend({}),zmStreamsApp.GroupApp.views=function(a){"use strict";var b=zmText.get("streams"),c=zmStreamsApp.GroupApp;return a.Group=Zmail.View.extend({events:{click:"loadPost","click .msi-chat":function(a){this.model.sync("createChat",this.model,{}),_zm.stopEvents(a)},"click .msi-mail":"opencompose"},loadPost:function(){var b=this.model.get("id");c.GroupId=b,a.groupHolder.find(".zmSLst").removeClass("zmSLst"),this.$el.addClass("zmSLst");var d="undefined"!=typeof zmAdHocSettings?zmAdHocSettings.getStreamsListType():"default";d="default"===d||"grid"===d,zmStreamsApp.constants.setElements(),zmStreamsApp.PostApp.init($(zmStreamsApp.constants.elements.postHolder),b,{view:"all",gridview:d},!0),$(this.$el).find(".msi-lcmnt").remove();var e=zmail.mailLeft.getNodes()[0].getLayer("zmStreamTree");e&&e.listObject[b]&&e.removeClassAtStart(b,"msi-lcmnt")},template:zmStreamsApp.GroupApp.template,opencompose:function(a){zmUtil.compose({TO:zmCont.getGroup(this.model.id).eid}),_zm.stopEvents(a)},promoteGroup:function(){var a=this.model.id,b=this.$el;if(a!==zmail.zuid){var c=$(b).parent(),d=$(b).detach();$(c).children().first().after(d)}},addCommentClass:function(){var a=this.$el;if(!$(a).find(".msi-lcmnt").length){var b=$(a).find(".zmFrm");$(b).append(this.template("commentClass"))}},updateUnread:function(){var a=this.$el,b=$(a).find(".zm_lbl"),c=this.model.get("unread");c=c<0?0:c,c?($(b).show(),$(a).find(".zmFrm").addClass("SC_bld")):($(b).hide(),$(a).find(".zmFrm").removeClass("SC_bld")),b.text(this.template("unreadText",c))},addRemMember:function(){var a=this.$el,c=this.model.get("members").length,d=c+(1===c?" "+b.common.labels.person:" "+b.common.labels.members);$(a).find(".sum").text(d)},render:function(){var a=this.template("groupList",this.model.toJSON());this.$el=$(a);var c=this.model,d=c.get("eid"),e=c.get("id")===zmail.zuid;if(d){var f=$(a).find(".msi-mail");zmComponent.tooltip({elm:f[0],text:b.streams.tooltip.mail,arrow:"top"})}if(!e){var g=$(a).find(".msi-chat");zmComponent.tooltip({elm:g[0],text:b.streams.tooltip.chat,arrow:"top"})}},removeGroup:function(){var a=this.$el;$(a).prev().click(),$(a).remove()},initialize:function(){var a=this,b=a.model;a.render(),b.on("loadPost",a.loadPost,a),a.listenTo(b,"change:unread",a.updateUnread),a.listenTo(b,"promoteGroup",a.promoteGroup),a.listenTo(b,"commentClass",a.addCommentClass),a.listenTo(b,"change:members",a.addRemMember),a.listenTo(b,"remove",a.removeGroup)}}),a}(zmStreamsApp.GroupApp.views),window.zmGroupSubscription=function(a){"use strict";var b,c,d=150,e=300,f=100,g=200,h="data-marker",i={SUBSCRIBE:"subscribe",CREATE_GROUP:"creategroup"},j=zmail.conPath+"/groupSubscription.do",k=zmail.defaultPhoto,l={},m={},n=[],o=[],p="",q=!1,r={},s=zmText.get("streams","groupSubscription"),t={groupItem:["DIV",{attrs:{"class":"zmL"},child:[["DIV",{attrs:{"class":"zmLst"},child:[["DIV",{attrs:{"class":"zmDtl"},child:[["DIV",{attrs:{"class":"zmImg"},child:[["IMG",{attrs:{"data-marker":"logo",src:""}}]]}],["DIV",{attrs:{"data-marker":"streamsdiv","class":"zmSze",style:"padding: 10px;"},child:[["SPAN",{child:[["I",{attrs:{"data-marker":"streams",style:"line-height: 10pt; vertical-align: middle;"}}],["SPAN",{attrs:{"data-marker":"streamstxt",style:"text-transform: capitalize; font-size: 10pt; line-height: 10pt; vertical-align: middle;"},child:[["text",s.lbl_enablestreams]]}]]}]]}],["DIV",{attrs:{"data-marker":"maildiv","class":"zmFdr",style:"padding: 10px;"},child:[["SPAN",{child:[["I",{attrs:{"data-marker":"mail",style:"line-height: 10pt; vertical-align: middle;"}}],["SPAN",{attrs:{"data-marker":"mailtxt",style:"text-transform: capitalize; font-size: 10pt; line-height: 10pt; vertical-align: middle;"},child:[["text",s.lbl_includemail]]}]]}]]}],["DIV",{attrs:{"class":"zmFrm"},child:[["SPAN",{attrs:{"data-marker":"name"}}]]}],["DIV",{attrs:{"class":"zmSub"},child:[["SPAN",{attrs:{"data-marker":"email","class":"sum"}}]]}]]}]]}]]}],emptyGroupList:["DIV",{attrs:{"class":"SC_nmsg"},child:[["text",s.msg_nogroups]]}],groupLogoInput:["INPUT",{attrs:{type:"file",accept:"image/*"}}],groupList:["DIV",{attrs:{"class":"SC_mc"}}],tabs:["DIV",{attrs:{"class":"SC_phd",style:"padding: 0; padding-top: 29px;"},child:[["UL",{attrs:{"class":"SCS_tab"},child:[["LI",{attrs:{"data-marker":"subscribeTab"},child:[["text",s.tab_subscribe]]}],["LI",{attrs:{"data-marker":"createTab"},child:[["text",s.tab_create]]}]]}]]}],createGroup:["DIV",{child:[["TABLE",{attrs:{width:"98%",cellspacing:"5","class":"SC_pvtbl",cellpadding:"5"},child:[["TBODY",{child:[["TR",{child:[["TD",{attrs:{rowspan:"3",width:"60px",valign:"top"},child:[["DIV",{attrs:{style:"cursor: pointer;","data-marker":"logodiv","class":"Sphoto",title:s.msg_imgsize_ttip},child:[["IMG",{attrs:{"data-marker":"logoimg",src:""}}]]}]]}],["TD",{child:[["DIV",{attrs:{"class":"SC_txt SC_tranbdr"},child:[["INPUT",{attrs:{"data-marker":"name",type:"text",placeholder:s.ph_grpname}}]]}]]}]]}],["TR",{child:[["TD",{child:[["DIV",{attrs:{"class":"SC_txt SC_tranbdr"},child:[["INPUT",{attrs:{"data-marker":"description",type:"text",placeholder:s.ph_grpdesc}}]]}]]}]]}],["TR",{child:[["TD",{child:[["DIV",{attrs:{"class":"SC_txt SC_tranbdr"},child:[["INPUT",{attrs:{"data-marker":"memberbox","class":"zm_sgst",type:"text",placeholder:s.ph_grpmems,autocomplete:"off"}}]]}]]}]]}]]}]]}],["DIV",{attrs:{"class":"SC_PUbtm",style:"padding: 10px; width: auto;"},child:[["SPAN",{attrs:{"class":"sel","data-marker":"createbtn"},child:[["text",s.btn_create]]}],["SPAN",{attrs:{"data-Val":"Cancel","data-marker":"cancelbtn"},child:[["text",s.btn_cancel]]}]]}]]}],tabContents:["DIV",{attrs:{style:"overflow: hidden; overflow-y: auto;"},child:[["DIV",{
attrs:{"data-marker":"listdiv",style:"display: none;"}}],["DIV",{attrs:{"data-marker":"creatediv",style:"display: none;"}}]]}]},u=function(a,b,c){b=b||{};for(var d=$("["+h+"]",a),e=0,f=d.length;e<f;e++)b[_zm.attr(d[e],h)]=d[e],c||d[e].removeAttribute(h);return a.hasAttribute(h)&&(b[_zm.attr(a,h)]=a,c||a.removeAttribute(h)),b},v=function(a){return _zm.getDOM(a)},w=function(a,b,c,d){zmsDialog.confirm(a,{onOk:b,onCancel:c,onHide:d})},x=_zm.succErrMsg,y=function(a){zmCont.addGroup(a.id,{name:a.name,desc:a.desc,photo:a.photo,members:a.memberids,moderator:a.moderator,isOwner:a.isOwner,owner:a.owner,eid:a.email,id:a.id})},z=function(){return zmsuite.isWorkspaceAvailable("zm_stream")||zmsuite.isWorkspaceAvailable("zmStreamsApp")||zmsuite.isWorkspaceAvailable("zm_Container")},A=function(a,b,c,d){zmAjq.XHR({u:j,p:a,fn:b,efn:c,ep:d,t:"post"})},B=function(a,b,c,d){var e,f=function(a){if("string"==typeof a)try{a=$.parseJSON(a)}catch(e){}a=a||[],a[0]&&1===a[0]?b(a[1],d):c(a[1],d)};if(window.FormData&&window.FileList){var g=new FormData;for(e in a)a[e].fileInput?a[e].fileInput.files.length&&g.append(e,a[e].fileInput.files[0]):g.append(e,a[e]);g.append("zmrcsr",zmAjq.getCookie("zmcsr")),$.ajax({url:j,data:g,processData:!1,contentType:!1,cache:!1,type:"POST",success:f,error:f})}else{for(e in a)a[e].fileInput&&delete a[e];A(a,b,c,d)}},C=function(){var a,b,c,d=["emptyGroupList","groupList","tabs","createGroup","tabContents"];for(a=0,b=d.length;a<b;a++)c=d[a],l[c]=v(t[c]),u(l[c],l);l.listdiv.appendChild(l.groupList),l.creatediv.appendChild(l.createGroup),l.groupLogo=v(t.groupLogoInput),l.tempLogo=v(t.groupLogoInput)},D=function(){l.previewCard=zmsuite.getCenter()[1],l.previewCardDOM=$(l.previewCard.$el),l.previewHeader=l.previewCard.getNodes()[0],l.previewContent=l.previewCard.getNodes()[1],l.previewHeader.push({text:[],rIcons:[[{tooltip:s.lbl_close,iconClass:"msi-close",data:"close"}]]}),l.previewContent.push(l.tabContents)},E=function(){l.previewHeader.push({text:[],rIcons:[[{tooltip:s.lbl_close,iconClass:"msi-close",data:"close"}]]}),l.previewContent.push(""),l.previewCard.getNodes()[0].setListener("click",b),l.previewCardDOM.removeClass("groupSubscription")},F=function(){var a=l.previewCard.getNodes()[0].getDOMNode()[0];a.childNodes[1].appendChild(l.tabs)},G=function(){zmUtil.setScrollShadow($(l.previewContent.getDOMNode()))},H=function(a){var b=m[a].elemMap,c=m[a].data;_zm.clearHTML(b.name),_zm.setTextContent(b.name,c.name),_zm.setAttr(b.name,{title:c.name}),b.logo.src=p+c.id,_zm.clearHTML(b.email),_zm.setTextContent(b.email,c.email),_zm.setAttr(b.email,{title:c.email}),b.streams.className=c.streams?"msi-check":"msi-uncheck",c.isorggroup||_zm.hide(b.maildiv),b.mail.className=c.mail?"msi-check":"msi-uncheck"},I=function(a){var b=m[a],c=b.data;if(b.requestInProgress)return void x("i",s.msg_reqinprocess);if(!c.streams&&c.memberids.length>d)return void x("e",s.msg_cantenable+". "+s.err_excessmems+"( "+d+" )");if(c.streams&&!zmail.showFeature)return void x("e",[s.msg_cantdisable,s.msg_disablenotsupported].join(". "));var e=function(d){var e,f="";b=m[a],b.requestInProgress=!1,b.data=d.group||b.data,c=b.data,c.streams?(f=s.msg_streamsenabled+' "'+c.name+'". '+s.msg_streamsenabled_2,e="group/streamsenabled"):(f=s.msg_streamsdisabled+' "'+c.name+'"',e="group/streamsdisabled"),x("s",f),y(c),$.publish(e,{id:a,name:c.name,membercount:c.memberids.length,members:c.memberids}),H(a)},f=function(d){b=m[a],b.requestInProgress=!1,d=d||{};var e=(c.streams?s.msg_cantdisable:s.msg_cantenable)+". "+(d.msg||s.msg_support);x("e",e)},g=function(){b.requestInProgress=!0;var d=c.streams?"disable":"enable";A({mode:"stream",gid:a,state:d},e,f)},h=(c.streams?s.msg_disableconf:s.msg_enableconf)+' "'+c.name+'"';c.streams?g():w(h,g)},J=function(a,b){var c=m[a],d=c.data;if(c.requestInProgress)return void x("i",s.msg_reqinprocess);var e=function(b){c=m[a],c.requestInProgress=!1,c.data=b.group||c.data,d=c.data,x("s",s.msg_mailboxcreated+' "'+d.email+'"'),H(a),$.publish("group/mailboxcreated",{id:a,email:d.email})},f=function(b){c=m[a],c.requestInProgress=!1,b=b||[];var d=s.msg_mbcreateerror+". "+b.msg||s.msg_support;x("e",d)};c.requestInProgress=!0,A({mode:"createmb",gid:a,email:b},e,f)},K=function(a){var b=m[a],c=b.data;if(!o||!o.length)return void x("e",s.err_nodomains+". "+s.msg_support);var d=c.name.toLowerCase(),e=d.replace(/ /gi,"_"),f=[];o.forEach(function(a){f.push(["OPTION",{attrs:{value:a},child:[["text",a]]}])});var g="mailbox_create",h=["H4",{child:[["text",s.msg_yourgroup+" '"+c.name+"' "+s.msg_creatembconf],["DIV",{child:[["INPUT",{attrs:{type:"text","data-marker":"email",value:e}}],["text"," @ "],["DIV",{attrs:{"class":"SC_select"},child:[["SELECT",{attrs:{"data-marker":"domain"},child:f}]]}]]}]]}],i=["DIV",{attrs:{id:g,style:"display: none;"},child:[h]}],j=_zm.getDOM(i),k=u(j),l=function(){zmsDialog.remove(),$("#"+g).remove()},n=function(){var b=k.email.value,c=k.domain.value,d=b+"@"+c;b&&d?(J(a,d),l()):x("e",s.err_invalidemail)},p={style:{width:"500px"},buttons:[{txt:s.txt_ok,callback:n},{isCancel:!0,txt:s.txt_cancel,callback:l}],mask:!0,hideclose:!1,pos:"center",closeaction:function(){$("#"+g).remove()},title:s.txt_mbcreatetitle};document.body.appendChild(j),zmsDialog.create(g,p)},L=function(a){var b,c,d=m[a],e=d.data;if(d.requestInProgress)return void x("i",s.msg_reqinprocess);var f=function(b){var c="";d=m[a],d.requestInProgress=!1,d.data=b.group||d.data,e=d.data,c=(e.mail?s.msg_mailincluded:s.msg_mailexcluded)+" "+e.name,x("s",c),H(a),$.publish(e.mail?"group/streamsmailincluded":"group/streamsmailexcluded",{id:d.id})},g=function(b){d=m[a],d.requestInProgress=!1,b=b||[];var c=e.mail?s.msg_cantexclude+". "+b.msg||s.msg_support:s.msg_cantinclude;x("e",c)},h=function(){d.requestInProgress=!0;var b=e.mail?"exclude":"include";A({mode:"mail",state:b,gid:a},f,g)};e.isorggroup?e.streams?e.hasmailbox?(b=(e.mail?s.msg_excludeconf:s.msg_includeconf)+' "'+e.name+'"',w(b,h)):e.email?(c=(e.mail?s.msg_cantdisable:s.msg_cantenable)+". "+s.msg_support,x("e",c)):q?K(a):x("e",s.err_mborgadmin):x("e",s.err_streamsnotenabled):x("e",s.err_notorggroup+". "+s.msg_support)},M=function(){var a=l.tempLogo;try{var b=a.files[0];if(Math.round(b.size/1024)>e)return!1}catch(c){}return!0},N=function(a){var b=m[a].elemMap;_zm.bind(b.streams,"click",I,[a]),_zm.bind(b.streamstxt,"click",I,[a]),_zm.bind(b.mail,"click",L,[a]),_zm.bind(b.mailtxt,"click",L,[a])},O=function(a){var b=function(a){_zm.removeClass(a.parentNode,"SC_tranbdr")},c=function(a){_zm.addClass(a.parentNode,"SC_tranbdr")};for(var d in a)_zm.bind(a[d],"focus",b,a[d]),_zm.bind(a[d],"blur",c,a[d])},P=function(){return!0},Q=function(){M()&&P()?(c(),x("i",s.msg_logopvwupd)):x("e",s.err_invalidlogo+" "+e+"KB")},R=function(){_zm.bind(l.tempLogo,"change",Q,[])};c=function(){l.groupLogo=l.tempLogo;try{var a=l.groupLogo.files[0],b=new FileReader;_zm.bind(b,"loadend",function(a){l.logoimg.src=a.result},[b]),b.readAsDataURL(a),l.tempLogo=v(t.groupLogoInput),R()}catch(c){x("e",s.err_photopreview)}};var S=function(a){var b={contentArray:"org",compare:["fn","","nn","eid"],LType:"3",OType:"2",display:"fn",eliminateAt:!0};zmAutoFill.setAutofill(b,$(a))},T=function(){l=null,m=null},U=function(){l.previewCard.close(),E(),T()},V=function(a){return!!a&&(!(0===a.length||a.length>f)&&!zmUtil.hasXSSChars(a))},W=function(a){return!(a&&a.length>g)&&(!a||!zmUtil.hasXSSChars(a))},X=function(a){return!!(a&&a.length>0&&a.length<=d)},Y=function(a){return V(a.name)?W(a.description)?X(a.members)?!(!P(a.logo)||!M(a.logo))||(x("e",s.err_invalidlogo+" "+e+"KB"),!1):(!a.members||a.members.length<0?x("e",s.errminmem):a.members.length>d&&x("e",zmText.applyArgs(s.errmaxmem,{max:d})),!1):(x("e",s.err_invalidgdesc+" "+g),!1):(x("e",s.err_invalidgname+" "+f),!1)},Z=function(){return{name:l.name.value||"",description:l.description.value||"",members:zmAutoFill.getAddress(l.memberbox),logo:l.groupLogo}},_=function(a,b){var c,d={},e={},f={};for(c in a.members)a.members[c]!==zmail.zuid&&(d[a.members[c]]=a.members[c],f[a.members[c]]=a.members[c]);for(c in b)b[c].zid!==zmail.zuid&&(e[b[c].zid]=b[c].zid,f[b[c].zid]=b[c].zid);var g=Object.keys(d).length,h=Object.keys(e).length,i=Object.keys(f).length;return g===h&&g===i},aa=function(a){var b,c=zmCont.getGroup(),d=[];for(var e in c)b=c[e],_(b,a)&&d.push(b.name);return d},ba=function(a){var b;"creating"===a?(_zm.addClass(l.createbtn,"sel"),b=s.btn_creating):"default"===a&&(_zm.removeClass(l.createbtn,"sel"),b=s.btn_create),_zm.clearHTML(l.createbtn),_zm.setTextContent(l.createbtn,b)},ca=function(){l.logoimg.src=k,l.tempLogo=v(t.groupLogoInput),l.groupLogo=l.tempLogo,R()},da=function(){ca(),l.name.value="",l.description.value="",l.memberbox.value="",_zm.remove(_zm(".","SC_cs",l.memberbox.parentNode)),zmAutoFill.clearData($(l.memberbox),""),S(l.memberbox),l.memberbox.placeholder=s.ph_grpmems},ea=function(a){var b,c,d,e=l.groupList;if(_zm.clearHTML(e),a)zmComponent.loadingBand({container:e,type:"pagination"});else if(Object.keys(m).length)for(d in n)b=n[d],m[b].dom||(c=v(t.groupItem),m[b].dom=c,m[b].elemMap=u(c),N(b),H(b)),e.appendChild(m[b].dom);else e.appendChild(l.emptyGroupList)},fa=function(a){m[a.id]={data:a},n.push(a.id),ea()},ga=function(a){r.createRequestInProgress=!0,ba("creating");var b=[];for(var c in a.members)b.push(String(a.members[c].zid));b=b.join(",");var d=function(a){r.createRequestInProgress=!1,ba("default");var b=a.group;b.photo=b.photo||p+b.id,fa(b),y(b),$.publish("group/streamsenabled",{id:b.id,name:b.name,membercount:b.memberids.length,members:b.memberids}),da(),x("s",s.msg_groupcreated)},e=function(a){r.createRequestInProgress=!1,ba("default"),a=a||{};var b=s.err_creategroup+". "+(a.msg||s.msg_support);x("e",b)};B({mode:"create",name:a.name,desc:a.description,mzuid:b,logo:{fileInput:a.logo}},d,e)},ha=function(){if(r.createRequestInProgress)return void x("i",s.msg_reqinprocess);var a=Z();if(Y(a)){var b=aa(a.members);if(b.length>0){var c=[s.msg_cnfnewgroup1,"( "+b.join(", ")+" )",s.msg_cnfnewgroup2].join("\n");w(c,function(){ga(a)})}else ga(a)}},ia=function(){O([l.name,l.description,l.memberbox]),S(l.memberbox),_zm.bind(l.createbtn,"click",ha,[]),_zm.bind(l.cancelbtn,"click",U,[]),_zm.bind(l.logodiv,"click",function(){l.tempLogo.click()},[]),R()},ja=function(){l.previewCard.getNodes()[0].setListener("click",U)},ka=function(a){_zm.removeClass(l.subscribeTab,"stSel"),_zm.removeClass(l.createTab,"stSel"),_zm.hide(l.listdiv),_zm.hide(l.creatediv),a===i.SUBSCRIBE?(_zm.addClass(l.subscribeTab,"stSel"),_zm.show(l.listdiv)):a===i.CREATE_GROUP&&(_zm.addClass(l.createTab,"stSel"),_zm.show(l.creatediv))},la=function(){_zm.bind(l.subscribeTab,"click",ka,[i.SUBSCRIBE]),_zm.bind(l.createTab,"click",ka,[i.CREATE_GROUP])},ma=function(){ja(),la(),ia(),G()},na=function(){var a=function(a){var b,c;q=a.isorgadmin,o=a.domains,p=a.photoURLPrefix,m={},n=[];for(b in a.groups)c=a.groups[b],c.photo=p+c.id,m[c.id]={data:c},n.push(c.id);ea()},b=function(a){var b=a&&a.msg||s.msg_support;x("e",s.err_groupslist+" - "+b+". "+s.err_groupslist_2),ea()};A({mode:"list"},a,b,[]),ea(!0)},oa=function(){l={},m={},n=[],o=[],p="",r={},C(),D(),l.previewCard.show(),l.previewCardDOM.addClass("groupSubscription"),F(),ma(),ca()},pa=function(a){b=a.onPreviewClose,z()&&b&&(oa(),ka(i.SUBSCRIBE),na())};return a=a||{},a.showPage=pa,a}();